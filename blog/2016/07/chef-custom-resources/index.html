<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="map[name:Jose Coelho]"><meta name=description content="Ramblings about software engineering"><meta name=keywords content="go,golang,kubernetes,ansible,chef,kafka,docker,containers"><link rel=canonical href=https://www.jacoelho.com/blog/2016/07/chef-custom-resources/><title>Chef Custom Resources :: Posts</title><link rel=stylesheet href=https://www.jacoelho.com/css/main.min.119ac2c18046a4ef9e7705b9cd71e1fc8cbe5a5139a1234cfdae109d1baedb3c.css integrity="sha256-EZrCwYBGpO+edwW5zXHh/Iy+WlE5oSNM/a4QnRuu2zw=" crossorigin=anonymous><meta itemprop=name content="Chef Custom Resources"><meta itemprop=description content="Lately I’ve been writing some Chef code. One of the best things about Chef
is custom resources:
https://docs.chef.io/custom_resources.html
Let’s see an example on how to create a Kafka topic
using Chef and how to make it
idempotent.
Before writing any Chef code it is important to understand how to manage a
topic (grouping of messages of a similar type).
From the Kafka install directory, first check if the topic already exists:
bin/kafka-topics.sh --zookeeper localhost:2181 \ --describe \ --topic <name> If it doesn’t exist, create it:"><meta itemprop=datePublished content="2016-07-13T10:24:46+00:00"><meta itemprop=dateModified content="2016-07-13T10:24:46+00:00"><meta itemprop=wordCount content="700"><meta itemprop=keywords content="Chef"><meta property="og:url" content="https://www.jacoelho.com/blog/2016/07/chef-custom-resources/"><meta property="og:site_name" content="Posts"><meta property="og:title" content="Chef Custom Resources"><meta property="og:description" content="Lately I’ve been writing some Chef code. One of the best things about Chef
is custom resources:
https://docs.chef.io/custom_resources.html
Let’s see an example on how to create a Kafka topic
using Chef and how to make it
idempotent.
Before writing any Chef code it is important to understand how to manage a
topic (grouping of messages of a similar type).
From the Kafka install directory, first check if the topic already exists:
bin/kafka-topics.sh --zookeeper localhost:2181 \ --describe \ --topic <name> If it doesn’t exist, create it:"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2016-07-13T10:24:46+00:00"><meta property="article:modified_time" content="2016-07-13T10:24:46+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Chef Custom Resources"><meta name=twitter:description content="Lately I’ve been writing some Chef code. One of the best things about Chef
is custom resources:
https://docs.chef.io/custom_resources.html
Let’s see an example on how to create a Kafka topic
using Chef and how to make it
idempotent.
Before writing any Chef code it is important to understand how to manage a
topic (grouping of messages of a similar type).
From the Kafka install directory, first check if the topic already exists:
bin/kafka-topics.sh --zookeeper localhost:2181 \ --describe \ --topic <name> If it doesn’t exist, create it:"><meta property="article:published_time" content="2016-07-13 10:24:46 +0000 UTC"><meta property="article:section" content="chef"></head><body><header class=header><div class=container><div class=header-inner><a href=https://www.jacoelho.com/ class=logo>Jose Coelho</a><nav class=nav><ul class=menu><li class=menu-item><a href=https://www.jacoelho.com/about/>About</a></li></ul><button class=menu-trigger aria-label="Toggle menu" aria-expanded=false>
<svg width="24" height="24"><use href="https://www.jacoelho.com/icons.svg#menu"/></svg>
</button>
<button class=theme-toggle aria-label="Toggle theme">
<svg class="theme-icon-light" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#sun"/></svg>
<svg class="theme-icon-dark" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#moon"/></svg>
</button>
<a href=https://www.jacoelho.com/index.xml class=rss-link target=_blank rel=noopener aria-label=RSS><svg width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#rss"/></svg></a></nav></div></div></header><div class=container><div class=content><main class=post><article><header class=post-header><h1 class=post-title>Chef Custom Resources</h1><div class=post-meta><span class=post-meta-item><time datetime=2016-07-13>July 13, 2016</time></span></div></header><div class=post-content><p>Lately I’ve been writing some <em>Chef</em> code. One of the best things about <em>Chef</em><br>is custom resources:<br><a href=https://docs.chef.io/custom_resources.html>https://docs.chef.io/custom_resources.html</a></p><p>Let’s see an example on how to create a <a href=https://kafka.apache.org/>Kafka</a> topic<br>using <em>Chef</em> and how to make it<br><a href=https://en.wikipedia.org/wiki/Idempotence>idempotent</a>.</p><p>Before writing any <em>Chef</em> code it is important to understand how to manage a<br><em>topic</em> (grouping of messages of a similar type).</p><p>From the <em>Kafka</em> install directory, first check if the <em>topic</em> already exists:</p><pre tabindex=0><code>bin/kafka-topics.sh
    --zookeeper localhost:2181 \
    --describe \
    --topic &lt;name&gt;
</code></pre><p>If it doesn&rsquo;t exist, create it:</p><pre tabindex=0><code>bin/kafka-topics.sh
    --zookeeper localhost:2181 \
    --create \
    --topic &lt;name&gt; \
    --replication-factor &lt;value&gt; \
    --partitions &lt;value&gt;
</code></pre><p>If the <em>topic</em> exists, to increase the number of <em>partitions</em> (way to<br>parallelize the consumption of messages from a topic):</p><pre tabindex=0><code>bin/kafka-topics.sh
    --zookeeper localhost:2181 \
    --alter \
    --topic &lt;name&gt; \
    --partitions &lt;value&gt;
</code></pre><p>If the topic exists, to increase the number of *replicas *(number of copies of<br>the partitions for data redundancy):</p><pre tabindex=0><code>bin/kafka-reassign-partitions.sh \
    --zookeeper localhost:2181 \
    --reassignment-json-file increase-replication-factor.json \
    --execute
</code></pre><p>Where the file <em>increase-replication-factor.json</em> follows the format:</p><pre tabindex=0><code>{
    &#34;version&#34;: 1,
    &#34;partitions&#34;: [
        {
        &#34;topic&#34;:&#34;foo&#34;,
        &#34;partition&#34;: 0,
        &#34;replicas&#34;:[1, 2, 3]
        }
    ]
}
</code></pre><p>The basic custom resource structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>property</span> <span class=ss>:topic</span><span class=p>,</span>      <span class=nb>String</span><span class=p>,</span> <span class=ss>name_property</span><span class=p>:</span> <span class=kp>true</span>
</span></span><span class=line><span class=cl><span class=n>property</span> <span class=ss>:partitions</span><span class=p>,</span> <span class=no>Fixnum</span><span class=p>,</span> <span class=ss>default</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>property</span> <span class=ss>:replicas</span><span class=p>,</span>   <span class=no>Fixnum</span><span class=p>,</span> <span class=ss>default</span><span class=p>:</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=n>property</span> <span class=ss>:zookeeper</span><span class=p>,</span>  <span class=nb>String</span><span class=p>,</span> <span class=ss>default</span><span class=p>:</span> <span class=s2>&#34;localhost:2181&#34;</span>
</span></span><span class=line><span class=cl><span class=n>property</span> <span class=ss>:directory</span><span class=p>,</span>  <span class=nb>String</span><span class=p>,</span> <span class=ss>default</span><span class=p>:</span> <span class=s2>&#34;/kafka&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>action</span> <span class=ss>:create</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>cmd</span> <span class=o>=</span> <span class=sx>%W(
</span></span></span><span class=line><span class=cl><span class=sx>    </span><span class=si>#{</span><span class=n>directory</span><span class=si>}</span><span class=sx>/bin/kafka-topics.sh
</span></span></span><span class=line><span class=cl><span class=sx>    --zookeeper </span><span class=si>#{</span><span class=n>zookeeper</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>    --create
</span></span></span><span class=line><span class=cl><span class=sx>    --topic </span><span class=si>#{</span><span class=n>topic</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>    --replication-factor </span><span class=si>#{</span><span class=n>replicas</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>    --partitions </span><span class=si>#{</span><span class=n>partitions</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>  )</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>shell_out</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>Using the resource (<a href=https://docs.chef.io/cookbooks.html>cookbook</a> example):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>example_topic</span> <span class=s2>&#34;example&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>partitions</span>  <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=n>replication</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>With this code creating <em>topics</em> is possible. However, it isn’t checking if the<br>topic already exists or if the settings are valid.</p><hr><h4 id=chefspec>ChefSpec</h4><p><a href=https://github.com/sethvargo/chefspec>ChefSpec</a> is a testing framework aimed<br>for testing <em>Chef</em> cookbooks.</p><p>In order to test a custom resource, first create the <em>ChefSpec</em> resource<br>matcher:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>if</span> <span class=n>defined?</span><span class=p>(</span><span class=no>ChefSpec</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>def</span> <span class=nf>create_example_topic</span><span class=p>(</span><span class=n>resource_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=no>ChefSpec</span><span class=o>::</span><span class=no>Matchers</span><span class=o>::</span><span class=no>ResourceMatcher</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>:example_topic</span><span class=p>,</span> <span class=ss>:create</span><span class=p>,</span> <span class=n>resource_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>Generate a <em>test_cookbook</em>:</p><pre tabindex=0><code>mkdir -p test/cookbooks
chef generate cookbook test/cookbooks/test_example
</code></pre><p>Create the file* test/cookbooks/test_example/recipes/create.rb*:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>example_topic</span> <span class=s2>&#34;example&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>partitions</span>  <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=n>replication</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>Update the file <em>test/cookbooks/test_example/metadata.rb</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>name</span> <span class=s2>&#34;test_example&#34;</span>
</span></span><span class=line><span class=cl><span class=n>maintainer</span> <span class=s2>&#34;The Authors&#34;</span>
</span></span><span class=line><span class=cl><span class=n>maintainer_email</span> <span class=s2>&#34;you@example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=n>license</span> <span class=s2>&#34;all_rights&#34;</span>
</span></span><span class=line><span class=cl><span class=n>description</span> <span class=s2>&#34;Installs/Configures test&#34;</span>
</span></span><span class=line><span class=cl><span class=n>long_description</span> <span class=s2>&#34;Installs/Configures test&#34;</span>
</span></span><span class=line><span class=cl><span class=n>version</span> <span class=s2>&#34;0.1.0&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>depends</span> <span class=s2>&#34;example&#34;</span> <span class=c1># example cookbook dependency</span>
</span></span></code></pre></div><p>Write the create test <em>spec/unit/recipes/create_spec.rb</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;spec_helper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span> <span class=s2>&#34;test_example&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>let</span><span class=p>(</span><span class=ss>:chef_conf</span><span class=p>)</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=no>ChefSpec</span><span class=o>::</span><span class=no>SoloRunner</span><span class=o>.</span><span class=n>new</span> <span class=ss>cookbook_path</span><span class=p>:</span> <span class=sx>%w(./test/cookbooks ../)</span><span class=p>,</span> <span class=c1># import test and example cookbook</span>
</span></span><span class=line><span class=cl>                             <span class=ss>step_into</span><span class=p>:</span>     <span class=sx>%w(example_topic)</span> <span class=c1># dive inside example_topic</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>let</span><span class=p>(</span><span class=ss>:shellout</span><span class=p>)</span> <span class=p>{</span> <span class=n>double</span><span class=p>(</span><span class=s2>&#34;shellout&#34;</span><span class=p>)</span> <span class=p>}</span> <span class=c1># setup shellout double</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>before</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>allow</span><span class=p>(</span><span class=no>Mixlib</span><span class=o>::</span><span class=no>ShellOut</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>receive</span><span class=p>(</span><span class=ss>:new</span><span class=p>)</span><span class=o>.</span><span class=n>and_return</span><span class=p>(</span><span class=n>shellout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>allow</span><span class=p>(</span><span class=n>shellout</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>receive_messages</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=ss>:run_command</span> <span class=o>=&gt;</span> <span class=kp>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>:error!</span> <span class=o>=&gt;</span> <span class=kp>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>:live_stream</span> <span class=o>=&gt;</span> <span class=kp>nil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=ss>:live_stream</span><span class=o>=</span> <span class=o>=&gt;</span> <span class=kp>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>describe</span> <span class=s2>&#34;topic create&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=n>let</span><span class=p>(</span><span class=ss>:chef_run</span><span class=p>)</span> <span class=p>{</span> <span class=n>chef_conf</span><span class=o>.</span><span class=n>converge</span><span class=p>(</span><span class=s2>&#34;test_example::create&#34;</span><span class=p>)</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>it</span> <span class=s2>&#34;converges successfully&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=n>allow</span><span class=p>(</span><span class=n>shellout</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>receive</span><span class=p>(</span><span class=ss>:stdout</span><span class=p>)</span><span class=o>.</span><span class=n>and_return</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;Created topic&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>expect</span> <span class=p>{</span> <span class=n>chef_run</span> <span class=p>}</span><span class=o>.</span><span class=n>to_not</span> <span class=n>raise_error</span>
</span></span><span class=line><span class=cl>      <span class=n>expect</span><span class=p>(</span><span class=n>chef_run</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>create_example_topic</span><span class=p>(</span><span class=s2>&#34;test&#34;</span><span class=p>)</span> <span class=c1># custom matcher in action</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span></code></pre></div><p>Now we can improve our resource with confidence — and all will still be working!</p><hr><p>At the moment the resource is quite simple and will try to create the topic<br>every time <em>Chef</em> runs. Now it’s time to find ways to improve it!</p><p>As seen before we can search for a <em>topic</em>:</p><pre tabindex=0><code>bin/kafka-topics.sh
    --zookeeper $ZK \
    --describe \
    --topic &lt;name&gt;
</code></pre><p>The output will be something like:</p><p><img src=https://cdn-images-1.medium.com/max/1600/1*ilfBGZvftKO0a8ljO2nx8g.png alt><br><span class=figcaption_hack>kafka describe topic</span></p><p>Example code to parse this output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=k>def</span> <span class=nf>list</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>zookeeper</span><span class=p>,</span> <span class=n>topic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>cmd</span> <span class=o>=</span> <span class=sx>%W(
</span></span></span><span class=line><span class=cl><span class=sx>    </span><span class=si>#{</span><span class=n>directory</span><span class=si>}</span><span class=sx>/bin/kafka-topics.sh
</span></span></span><span class=line><span class=cl><span class=sx>    --zookeeper </span><span class=si>#{</span><span class=n>zookeeper</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>    --describe
</span></span></span><span class=line><span class=cl><span class=sx>    --topic </span><span class=si>#{</span><span class=n>topic</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>  )</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>shell_out</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span><span class=o>.</span><span class=n>stdout</span>
</span></span><span class=line><span class=cl>  <span class=n>extract</span> <span class=o>=</span> <span class=o>-&gt;</span><span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=p>{</span> <span class=n>a</span> <span class=o>&amp;&amp;</span> <span class=n>a</span><span class=o>.</span><span class=n>to_i</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=ss>partitions</span><span class=p>:</span> <span class=n>extract</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>result</span><span class=o>[</span><span class=sr>/PartitionCount:\s*(\d+)/</span><span class=p>,</span> <span class=mi>1</span><span class=o>]</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=ss>replicas</span><span class=p>:</span> <span class=n>extract</span><span class=o>.</span><span class=n>call</span><span class=p>(</span><span class=n>result</span><span class=o>[</span><span class=sr>/ReplicationFactor:\s*(\d+)/</span><span class=p>,</span> <span class=mi>1</span><span class=o>]</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>With this we create a consistent view between <em>Chef</em> and the actual resource:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>load_current_value</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>current_partitions</span><span class=p>,</span> <span class=n>current_replicas</span> <span class=o>=</span> <span class=n>list</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>zookeeper</span><span class=p>,</span> <span class=n>topic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                                         <span class=o>.</span><span class=n>values_at</span> <span class=o>*</span><span class=sx>%w(partitions replicas)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>current_value_does_not_exist!</span> <span class=k>unless</span> <span class=n>current_partitions</span> <span class=o>&amp;&amp;</span> <span class=n>current_replicas</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>partitions</span> <span class=n>current_partitions</span>
</span></span><span class=line><span class=cl>  <span class=n>replicas</span> <span class=n>current_replicas</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>Refactoring the “<em>create action</em>”:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>action</span> <span class=ss>:create</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># calls the block if current_resource does not exist</span>
</span></span><span class=line><span class=cl>  <span class=c1># or values are different from current_resource</span>
</span></span><span class=line><span class=cl>  <span class=n>converge_if_changed</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>current_resource</span>
</span></span><span class=line><span class=cl>      <span class=n>action_update</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>converge_by</span> <span class=s2>&#34;Create topic </span><span class=si>#{</span><span class=n>new_resource</span><span class=o>.</span><span class=n>topic</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=n>create!</span> <span class=n>new_resource</span><span class=o>.</span><span class=n>directory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>new_resource</span><span class=o>.</span><span class=n>zookeeper</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>new_resource</span><span class=o>.</span><span class=n>topic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>new_resource</span><span class=o>.</span><span class=n>partitions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>new_resource</span><span class=o>.</span><span class=n>replicas</span>
</span></span><span class=line><span class=cl>      <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl>  <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>“<em>Update action</em>”:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>action</span> <span class=ss>:update</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>alter!</span> <span class=n>new_resource</span><span class=o>.</span><span class=n>directory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>new_resource</span><span class=o>.</span><span class=n>zookeeper</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>new_resource</span><span class=o>.</span><span class=n>topic</span><span class=p>,</span>
</span></span><span class=line><span class=cl>         <span class=n>new_resource</span><span class=o>.</span><span class=n>partitions</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;chef/log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>alter!</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>zookeeper</span><span class=p>,</span> <span class=n>topic</span><span class=p>,</span> <span class=n>partitions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>cmd</span> <span class=o>=</span> <span class=sx>%W(
</span></span></span><span class=line><span class=cl><span class=sx>    </span><span class=si>#{</span><span class=n>directory</span><span class=si>}</span><span class=sx>/bin/kafka-topics.sh
</span></span></span><span class=line><span class=cl><span class=sx>    --zookeeper </span><span class=si>#{</span><span class=n>zookeeper</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>    --alter
</span></span></span><span class=line><span class=cl><span class=sx>    --topic </span><span class=si>#{</span><span class=n>topic</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>    --partitions </span><span class=si>#{</span><span class=n>partitions</span><span class=si>}</span><span class=sx>
</span></span></span><span class=line><span class=cl><span class=sx>  )</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=n>shell_out</span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=no>Chef</span><span class=o>::</span><span class=no>Log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>stderr</span><span class=p>)</span> <span class=k>unless</span> <span class=n>result</span><span class=o>.</span><span class=n>stdout</span> <span class=o>=~</span> <span class=sr>/Adding partitions succeeded!/</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>This small example goes to show just how powerful the <em>Chef</em> <em>DSL</em> is and how it<br>helps in the creation of idempotent resources.</p><p>The full example (with tests) is available in the github:<br><a href=https://github.com/jacoelho/example>link</a></p></div><div class=post-categories><a href=https://www.jacoelho.com/categories/chef class=category>chef</a></div></article></main></div></div><footer class=footer><div class=container><div class=footer-content><span>&copy; 2025 Jose Coelho</span></div></div></footer><script src=https://www.jacoelho.com/js/bundle.min.2868f841c78e77d7b473d034a52bb46f21b12eef84caba5767ed9a65576ecb3c.js integrity="sha256-KGj4QceOd9e0c9A0pSu0byGxLu+EyrpXZ+2aZVduyzw=" crossorigin=anonymous></script></body></html>