<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Jose Coelho"><meta name=description content="Ramblings about software engineering"><meta name=keywords content="go,golang,kubernetes,ansible,chef,kafka,docker,containers"><link rel=canonical href=https://www.jacoelho.com/blog/2022/05/opentelemetry-log-based-change-data-capture-tracing/><title>Opentelemetry - Log-Based Change Data Capture tracing :: Posts</title><link rel=stylesheet href=https://www.jacoelho.com/css/main.min.6f3353616359b0fe4cfe1d29dc41b46980dd1459838e2e6175f34881197cc945.css integrity="sha256-bzNTYWNZsP5M/h0p3EG0aYDdFFmDji5hdfNIgRl8yUU=" crossorigin=anonymous><meta itemprop=name content="Opentelemetry - Log-Based Change Data Capture tracing"><meta itemprop=description content="Opentelemetry provides vendor neutral standards and implementations to generate, collect, and export tracing data.
A Context is a propagation mechanism which carries execution-scoped values across API boundaries and between logically associated execution units. Cross-cutting concerns access their data in-process using the same shared Context object.
Context propagation is required when the tracing needs to cross process or service boundaries. Common ways to propagate the context is using W3C Trace Context or Zipkin B3 headers, while to inject the context is, for example, http headers or metadata fields in event messages."><meta itemprop=datePublished content="2022-05-02T10:00:00+00:00"><meta itemprop=dateModified content="2022-05-02T10:00:00+00:00"><meta itemprop=wordCount content="395"><meta itemprop=keywords content="Opentelemetry,Otel,Go,Golang,Cdc,Change Data Capture,Postgresql"><meta property="og:url" content="https://www.jacoelho.com/blog/2022/05/opentelemetry-log-based-change-data-capture-tracing/"><meta property="og:site_name" content="Posts"><meta property="og:title" content="Opentelemetry - Log-Based Change Data Capture tracing"><meta property="og:description" content="Opentelemetry provides vendor neutral standards and implementations to generate, collect, and export tracing data.
A Context is a propagation mechanism which carries execution-scoped values across API boundaries and between logically associated execution units. Cross-cutting concerns access their data in-process using the same shared Context object.
Context propagation is required when the tracing needs to cross process or service boundaries. Common ways to propagate the context is using W3C Trace Context or Zipkin B3 headers, while to inject the context is, for example, http headers or metadata fields in event messages."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-05-02T10:00:00+00:00"><meta property="article:modified_time" content="2022-05-02T10:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Opentelemetry - Log-Based Change Data Capture tracing"><meta name=twitter:description content="Opentelemetry provides vendor neutral standards and implementations to generate, collect, and export tracing data.
A Context is a propagation mechanism which carries execution-scoped values across API boundaries and between logically associated execution units. Cross-cutting concerns access their data in-process using the same shared Context object.
Context propagation is required when the tracing needs to cross process or service boundaries. Common ways to propagate the context is using W3C Trace Context or Zipkin B3 headers, while to inject the context is, for example, http headers or metadata fields in event messages."><meta property="article:published_time" content="2022-05-02 10:00:00 +0000 UTC"><meta property="article:section" content="opentelemetry"><meta property="article:section" content="otel"><meta property="article:section" content="go"><meta property="article:section" content="golang"><meta property="article:section" content="cdc"><meta property="article:section" content="change data capture"><meta property="article:section" content="postgresql"></head><body><header class=header><div class=container><div class=header-inner><a href=https://www.jacoelho.com/ class=logo>Jose Coelho</a><nav class=nav><button class=menu-trigger aria-label="Toggle menu" aria-expanded=false>
<svg width="24" height="24"><use href="https://www.jacoelho.com/icons.svg#menu"/></svg></button><div class=nav-menu><ul class=menu><li class=menu-item><a href=https://www.jacoelho.com/about/>About</a></li></ul><button class=theme-toggle aria-label="Toggle theme">
<svg class="theme-icon-light" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#sun"/></svg>
<svg class="theme-icon-dark" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#moon"/></svg>
</button>
<a href=https://www.jacoelho.com/index.xml class=rss-link target=_blank rel=noopener aria-label=RSS><svg width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#rss"/></svg></a></div></nav></div></div></header><div class=container><div class=content><main class=post><article><header class=post-header><h1 class=post-title>Opentelemetry - Log-Based Change Data Capture tracing</h1></header><div class=post-content><p><a href=https://opentelemetry.io/>Opentelemetry</a> provides vendor neutral standards and implementations to generate, collect, and export tracing data.</p><p>A Context is a propagation mechanism which carries execution-scoped values across API boundaries and between logically associated execution units. Cross-cutting concerns access their data in-process using the same shared Context object.</p><p>Context propagation is required when the tracing needs to cross process or service boundaries. Common ways to propagate the context is using <a href=https://www.w3.org/TR/trace-context/>W3C Trace Context</a> or <a href=https://github.com/openzipkin/b3-propagation>Zipkin B3 headers</a>, while to inject the context is, for example, http headers or metadata fields in event messages.</p><p>Sometimes there is no clear way to propagate the context, for example, when using Log-Based <a href=https://en.wikipedia.org/wiki/Change_data_capture>Change Data Capture</a>:</p><p><img src=https://www.jacoelho.com/images/cdc.png alt=url></p><p>There is no simple mechanism to propagate &ldquo;Application A&rdquo; context to &ldquo;Application B&rdquo; without, for example, polluting records with ephemeral data or using additional datastore.</p><p>There are some solutions like <a href=https://google.github.io/sqlcommenter>sqlcommenter</a> that rely on log analysis, but don&rsquo;t address the propagation.</p><h4 id=inside-the-wal>Inside the WAL</h4><p>In PostgreSQL 9.6 <a href=https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-REPLICATION-TABLE>pg_logical_emit_message</a> was introduced, which can be used to pass generic messages to logical decoding plugins through WAL.</p><p><a href=https://www.postgresql.org/docs/current/logical-replication-architecture.html>pgoutput</a> supports logical decoding messages since <a href=https://www.postgresql.org/docs/current/protocol-logicalrep-message-formats.html>version 14</a>, when the flag <code>messages</code> is set to <code>true</code>.</p><p>Setting <code>pg_logical_emit_message</code> <code>transactional</code> flag to <code>true</code> it is possible to aggregate the message with transaction.</p><p>As an example, defining the following helper function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>const</span><span class=w> </span><span class=nx>propagationQuery</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>`select pg_logical_emit_message(true,&#39;otelwal&#39;,$1);`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>stringMap</span><span class=w> </span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>Inject</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>tx</span><span class=w> </span><span class=o>*</span><span class=nx>sql</span><span class=p>.</span><span class=nx>Tx</span><span class=p>,</span><span class=w> </span><span class=nx>p</span><span class=w> </span><span class=nx>propagation</span><span class=p>.</span><span class=nx>TextMapPropagator</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>m</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>make</span><span class=p>(</span><span class=nx>stringMap</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>p</span><span class=p>.</span><span class=nf>Inject</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>rows</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>tx</span><span class=p>.</span><span class=nf>QueryContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>propagationQuery</span><span class=p>,</span><span class=w> </span><span class=nx>m</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>rows</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>With helper function a user can manually propagate the context:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>tx</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>db</span><span class=p>.</span><span class=nf>BeginTx</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>otelwal</span><span class=p>.</span><span class=nf>Inject</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>tx</span><span class=p>,</span><span class=w> </span><span class=nx>propagation</span><span class=p>.</span><span class=nx>TraceContext</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nx>_</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>tx</span><span class=p>.</span><span class=nf>Exec</span><span class=p>(</span><span class=s>`insert into foo (id, val) values ($1,$2)`</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>tx</span><span class=p>.</span><span class=nf>Commit</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>...</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Checking emitted changes using <a href=https://github.com/eulerto/wal2json>wal2json</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;change&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;message&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;transactional&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;otelwal&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;{\&#34;traceparent\&#34;:\&#34;00-8a9e294a6655a610899ec9f09dfff0d0-07c8d67a7650d803-01\&#34;}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;insert&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;schema&#34;</span><span class=p>:</span> <span class=s2>&#34;public&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;table&#34;</span><span class=p>:</span> <span class=s2>&#34;foo&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;columnnames&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;val&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;columntypes&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;integer&#34;</span><span class=p>,</span> <span class=s2>&#34;integer&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                  <span class=nt>&#34;columnvalues&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>With this information, the cdc library can pick the context and propagate accordingly.</p><h4 id=conclusion>Conclusion</h4><p>Using <code>pg_logical_emit_message</code> with conjunction with transactions allows to propagate opentelemetry tracing information across the database layer without requiring extra machinery at the expense of extra transactions and bytes across the wire.</p></div></article></main></div></div><footer class=footer><div class=container><div class=footer-content><span>&copy; 2025 Jose Coelho</span></div></div></footer><script src=https://www.jacoelho.com/js/bundle.min.c687f63d8e204d7466c7c9609ec6f61b44c1217490b36198e5f77ee3befc11ea.js integrity="sha256-xof2PY4gTXRmx8lgnsb2G0TBIXSQs2GY5fd+4778Eeo=" crossorigin=anonymous></script></body></html>