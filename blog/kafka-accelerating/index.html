<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="Jose Coelho ">
<meta name="description" content="Quick tips and insights on how to make Apache Kafka work faster!
Hardware  CPU doesn&amp;rsquo;t matter that much. Memory helps a lot (a lot) in performance. SSDs are not required, since most operations are sequential read and writes. If possible run in bare metal.  Linux  Configure to maximize memory usage (tweak until you feel comfortable):  vm.dirty_background_ratio = 5 vm.dirty_ratio = 80 vm.swappiness = 1  Assuming you are using ext4, don’t waste space with reserved blocks:  tune2fs -m 0 -i 0 -c -1 /dev/device  Mount with noatime:  /dev/device /mountpoint ext4 defaults,noatime  Keep an eye on the number of free inodes:  tune2fs -l /dev/device | grep -i inode  Increase limits, for example, using systemd:  $ cat /etc/systemd/system/kafka." />
<meta name="keywords" content="go, golang, kubernetes, ansible, chef, kafka, docker, containers" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<link rel="canonical" href="https://www.jacoelho.com/blog/kafka-accelerating/" />


    <title>
        
            Kafka — Accelerating! :: Posts  — Hello Friend NG Theme
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="https://www.jacoelho.com/main.5065e7e2de9ed3289e28981aa60c3b19d30986c09df329b604aa6a4c0fe76056.css">




    <link rel="apple-touch-icon" sizes="180x180" href="https://www.jacoelho.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.jacoelho.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.jacoelho.com/favicon-16x16.png">
    <link rel="manifest" href="https://www.jacoelho.com/site.webmanifest">
    <link rel="mask-icon" href="https://www.jacoelho.com/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://www.jacoelho.com/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">



<meta itemprop="name" content="Kafka — Accelerating!">
<meta itemprop="description" content="Quick tips and insights on how to make Apache Kafka work faster!
Hardware  CPU doesn&rsquo;t matter that much. Memory helps a lot (a lot) in performance. SSDs are not required, since most operations are sequential read and writes. If possible run in bare metal.  Linux  Configure to maximize memory usage (tweak until you feel comfortable):  vm.dirty_background_ratio = 5 vm.dirty_ratio = 80 vm.swappiness = 1  Assuming you are using ext4, don’t waste space with reserved blocks:  tune2fs -m 0 -i 0 -c -1 /dev/device  Mount with noatime:  /dev/device /mountpoint ext4 defaults,noatime  Keep an eye on the number of free inodes:  tune2fs -l /dev/device | grep -i inode  Increase limits, for example, using systemd:  $ cat /etc/systemd/system/kafka.">
<meta itemprop="datePublished" content="2016-11-22T10:24:46+00:00" />
<meta itemprop="dateModified" content="2016-11-22T10:24:46+00:00" />
<meta itemprop="wordCount" content="303">
<meta itemprop="image" content="https://www.jacoelho.com/"/>



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.jacoelho.com/"/>

<meta name="twitter:title" content="Kafka — Accelerating!"/>
<meta name="twitter:description" content="Quick tips and insights on how to make Apache Kafka work faster!
Hardware  CPU doesn&rsquo;t matter that much. Memory helps a lot (a lot) in performance. SSDs are not required, since most operations are sequential read and writes. If possible run in bare metal.  Linux  Configure to maximize memory usage (tweak until you feel comfortable):  vm.dirty_background_ratio = 5 vm.dirty_ratio = 80 vm.swappiness = 1  Assuming you are using ext4, don’t waste space with reserved blocks:  tune2fs -m 0 -i 0 -c -1 /dev/device  Mount with noatime:  /dev/device /mountpoint ext4 defaults,noatime  Keep an eye on the number of free inodes:  tune2fs -l /dev/device | grep -i inode  Increase limits, for example, using systemd:  $ cat /etc/systemd/system/kafka."/>



    <meta property="og:title" content="Kafka — Accelerating!" />
<meta property="og:description" content="Quick tips and insights on how to make Apache Kafka work faster!
Hardware  CPU doesn&rsquo;t matter that much. Memory helps a lot (a lot) in performance. SSDs are not required, since most operations are sequential read and writes. If possible run in bare metal.  Linux  Configure to maximize memory usage (tweak until you feel comfortable):  vm.dirty_background_ratio = 5 vm.dirty_ratio = 80 vm.swappiness = 1  Assuming you are using ext4, don’t waste space with reserved blocks:  tune2fs -m 0 -i 0 -c -1 /dev/device  Mount with noatime:  /dev/device /mountpoint ext4 defaults,noatime  Keep an eye on the number of free inodes:  tune2fs -l /dev/device | grep -i inode  Increase limits, for example, using systemd:  $ cat /etc/systemd/system/kafka." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.jacoelho.com/blog/kafka-accelerating/" />
<meta property="og:image" content="https://www.jacoelho.com/"/>
<meta property="article:published_time" content="2016-11-22T10:24:46+00:00" />
<meta property="article:modified_time" content="2016-11-22T10:24:46+00:00" />






    <meta property="article:published_time" content="2016-11-22 10:24:46 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://www.jacoelho.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">Jose Coelho</span>
            <span class="logo__cursor" style=
                  "visibility:hidden;
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://www.jacoelho.com/about/">About</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">

    <div class="post-info">
        
        </p>
    </div>

    <article>
        <h2 class="post-title"><a href="https://www.jacoelho.com/blog/kafka-accelerating/">Kafka — Accelerating!</a></h2>

        

        

        <div class="post-content">
            <p>Quick tips and insights on how to make <a href="https://kafka.apache.org/">Apache Kafka</a>
work faster!</p>
<h3 id="hardware">Hardware</h3>
<ul>
<li>CPU doesn&rsquo;t matter that much.</li>
<li>Memory helps a lot (a lot) in performance.</li>
<li>SSDs are not required, since most operations are sequential read and writes.</li>
<li>If possible run in <a href="https://www.ibm.com/blogs/cloud-computing/2014/07/bare-metal-vs-virtual-servers-choice-right/">bare
metal</a>.</li>
</ul>
<h3 id="linux">Linux</h3>
<ul>
<li>Configure to <a href="http://www.makelinux.net/books/lkd2/ch15lev1sec4">maximize memory
usage</a> (tweak until you feel comfortable):</li>
</ul>
<pre><code>vm.dirty_background_ratio = 5
vm.dirty_ratio = 80
vm.swappiness = 1
</code></pre><ul>
<li>Assuming you are using <em>ext4</em>, don’t waste space with reserved blocks:</li>
</ul>
<pre><code>tune2fs -m 0 -i 0 -c -1 /dev/device
</code></pre><ul>
<li>Mount with <em>noatime</em>:</li>
</ul>
<pre><code>/dev/device       /mountpoint       ext4    defaults,noatime
</code></pre><ul>
<li>Keep an eye on the number of free <em>inodes</em>:</li>
</ul>
<pre><code>tune2fs -l /dev/device | grep -i inode
</code></pre><ul>
<li>Increase limits, for example, using <em>systemd</em>:</li>
</ul>
<pre><code>$ cat /etc/systemd/system/kafka.service.d/limits.conf
[Service]
LimitNOFILE=10000
</code></pre><ul>
<li>Tweak your network settings, for example:</li>
</ul>
<pre><code>net.core.somaxconn = 1024
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_syncookies = 1
</code></pre><h3 id="kafka">Kafka</h3>
<ul>
<li><em>log.dirs</em> accepts a comma separated list of disks and will distribute
partitions across them, however:</li>
</ul>
<ol>
<li>Doesn’t rebalance, some disks could be full and others empty.</li>
<li>Doesn’t tolerate any disk failure, more info in
<a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-18+-+JBOD+Support">KIP-18</a>.</li>
<li><em>Raid 10</em> is probably the best middle ground between performance and
reliability.</li>
</ol>
<ul>
<li>*num.io.threads, *number of I/O threads that the server uses for executing
requests. You should have at least as many threads as you have disks.</li>
<li><em>num.network.threads</em>, number of network threads that the server uses for
handling network requests. Increase based on number of producers/consumers and
replication factor.</li>
<li>Use Java 1.8 and <a href="http://www.oracle.com/technetwork/articles/java/g1gc-1984535.html">G1 Garbage
collector</a>:</li>
</ul>
<pre><code>-XX:MetaspaceSize=96m
-XX:+UseG1GC            # use G1
-XX:MaxGCPauseMillis=20 # gc deadline
-XX:InitiatingHeapOccupancyPercent=35
-XX:G1HeapRegionSize=16M
-XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=80
</code></pre><ul>
<li><em>KAFKA_HEAP_OPTS</em>, 5–8Gb heap should be enough for most deployments, file system
cache is way more important. <em>Linkedin</em> runs <a href="http://docs.confluent.io/1.0/kafka/deployment.html">5Gb heap in 32Gb RAM
servers</a>.</li>
<li><a href="https://github.com/tobert/pcstat">pcstat</a> can help understand how well the
system is caching:</li>
</ul>
<pre><code>./pcstat /kafka/data/*
</code></pre><hr>
<p>Any comments or suggestions are welcome!</p>

        </div>
    </article>

    <hr />

    <div class="post-info">
        
        
    </div>
</main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2020</span>
            
            <span><a href="https://www.jacoelho.com/">Jose Coelho</a></span>
            
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            
            <span> <a
                    href="https://www.jacoelho.com/posts/index.xml" target="_blank" title="rss"><svg
                        xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-rss">
                        <path d="M4 11a9 9 0 0 1 9 9"></path>
                        <path d="M4 4a16 16 0 0 1 16 16"></path>
                        <circle cx="5" cy="19" r="1"></circle>
                    </svg></a></span>
        </div>
    </div>
</footer>
            
        </div>

        




<script type="text/javascript" src="https://www.jacoelho.com/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js" integrity="sha512-3HFukJLJggt3&#43;W2ilNASCu6xibW86pdSMJ6&#43;on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script>



    </body>
</html>
