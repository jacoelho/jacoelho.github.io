<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.54.0" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Jose Coelho" />
  <meta property="og:url" content="https://www.jacoelho.com/blog/kafka-accelerating/" />
  <link rel="canonical" href="https://www.jacoelho.com/blog/kafka-accelerating/" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.jacoelho.com"
      },
      "articleSection" : "blog",
      "name" : "Kafka — Accelerating!",
      "headline" : "Kafka — Accelerating!",
      "description" : "Kafka — Accelerating! Quick tips and insights on how to make Apache Kafka work faster!
Hardware  CPU doesn&rsquo;t matter that much. Memory helps a lot (a lot) in performance. SSDs are not required, since most operations are sequential read and writes. If possible run in bare metal.  Linux  Configure to maximize memory usage (tweak until you feel comfortable):
vm.dirty_background_ratio = 5 vm.dirty_ratio = 80 vm.swappiness = 1  Assuming you are using ext4, don’t waste space with reserved blocks:",
      "inLanguage" : "en-US",
      "author" : "Jose Coelho",
      "creator" : "Jose Coelho",
      "publisher": "Jose Coelho",
      "accountablePerson" : "Jose Coelho",
      "copyrightHolder" : "Jose Coelho",
      "copyrightYear" : "2016",
      "datePublished": "2016-11-22 10:24:46 &#43;0000 UTC",
      "dateModified" : "2016-11-22 10:24:46 &#43;0000 UTC",
      "url" : "https://www.jacoelho.com/blog/kafka-accelerating/",
      "keywords" : [  ]
  }
</script>
<title>Kafka — Accelerating! - Jose Coelho</title>
  <meta property="og:title" content="Kafka — Accelerating! - Jose Coelho" />
  <meta property="og:type" content="article" />
  <meta name="description" content="Kafka — Accelerating! Quick tips and insights on how to make Apache Kafka work faster!
Hardware  CPU doesn&rsquo;t matter that much. Memory helps a lot (a lot) in performance. SSDs are not required, since most operations are sequential read and writes. If possible run in bare metal.  Linux  Configure to maximize memory usage (tweak until you feel comfortable):
vm.dirty_background_ratio = 5 vm.dirty_ratio = 80 vm.swappiness = 1  Assuming you are using ext4, don’t waste space with reserved blocks:" />

  <link
    rel="stylesheet"
    href="/css/flexboxgrid.min.css"
  />
  <link
    rel="stylesheet"
    href="/css/highlight/dracula.min.css"
  />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Jose Coelho">
  
  <script>
    

    (function(undefined) {}).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>

  
</head>


  <body>
    <article class="post " id="article">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3">
          <header class="post-header">
            <h1 class="post-title">Kafka — Accelerating!</h1>
            <div class="row">
              <div class="col-xs-6">
                <time class="post-date" datetime="2016-11-22 10:24:46 UTC">
                  22 Nov 2016
                </time>
              </div>
              <div class="col-xs-6">
                <div class="post-author">
                  <a target="_blank" href="https://joway.io/">@Jose Coelho</a>
                </div>
              </div>
            </div>
          </header>

          <div class="post-content markdown-body">
            

<h1 id="kafka-accelerating">Kafka — Accelerating!</h1>

<p>Quick tips and insights on how to make <a href="https://kafka.apache.org/">Apache Kafka</a>
work faster!</p>

<h3 id="hardware">Hardware</h3>

<ul>
<li>CPU doesn&rsquo;t matter that much.</li>
<li>Memory helps a lot (a lot) in performance.</li>
<li>SSDs are not required, since most operations are sequential read and writes.</li>
<li>If possible run in <a href="https://www.ibm.com/blogs/cloud-computing/2014/07/bare-metal-vs-virtual-servers-choice-right/">bare
metal</a>.</li>
</ul>

<h3 id="linux">Linux</h3>

<ul>
<li><p>Configure to <a href="http://www.makelinux.net/books/lkd2/ch15lev1sec4">maximize memory
usage</a> (tweak until you feel comfortable):</p>

<pre><code>vm.dirty_background_ratio = 5
vm.dirty_ratio = 80
vm.swappiness = 1
</code></pre></li>

<li><p>Assuming you are using <em>ext4</em>, don’t waste space with reserved blocks:</p>

<pre><code>tune2fs -m 0 -i 0 -c -1 /dev/device
</code></pre></li>

<li><p>Mount with <em>noatime</em>:</p>

<pre><code>/dev/device       /mountpoint       ext4    defaults,noatime
</code></pre></li>

<li><p>Keep an eye on the number of free <em>inodes</em>:</p>

<pre><code>tune2fs -l /dev/device | grep -i inode
</code></pre></li>

<li><p>Increase limits, for example, using <em>systemd</em>:</p>

<pre><code>$ cat /etc/systemd/system/kafka.service.d/limits.conf
[Service]
LimitNOFILE=10000
</code></pre></li>

<li><p>Tweak your network settings, for example:</p>

<pre><code>net.core.somaxconn = 1024
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_syncookies = 1
</code></pre></li>
</ul>

<h3 id="kafka">Kafka</h3>

<ul>
<li><em>log.dirs</em> accepts a comma separated list of disks and will distribute
partitions across them, however:</li>
</ul>

<ol>
<li>Doesn’t rebalance, some disks could be full and others empty.</li>
<li>Doesn’t tolerate any disk failure, more info in
<a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-18+-+JBOD+Support">KIP-18</a>.</li>
<li><em>Raid 10</em> is probably the best middle ground between performance and
reliability.</li>
</ol>

<ul>
<li>*num.io.threads, *number of I/O threads that the server uses for executing
requests. You should have at least as many threads as you have disks.</li>
<li><em>num.network.threads</em>, number of network threads that the server uses for
handling network requests. Increase based on number of producers/consumers and
replication factor.</li>
<li>Use Java 1.8 and <a href="http://www.oracle.com/technetwork/articles/java/g1gc-1984535.html">G1 Garbage
collector</a>:</li>
</ul>

<pre><code>-XX:MetaspaceSize=96m
-XX:+UseG1GC            # use G1
-XX:MaxGCPauseMillis=20 # gc deadline
-XX:InitiatingHeapOccupancyPercent=35
-XX:G1HeapRegionSize=16M
-XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=80
</code></pre>

<ul>
<li>_KAFKA_HEAP<em>OPTS</em>, 5–8Gb heap should be enough for most deployments, file system
cache is way more important. <em>Linkedin</em> runs <a href="http://docs.confluent.io/1.0/kafka/deployment.html">5Gb heap in 32Gb RAM
servers</a>.</li>
<li><a href="https://github.com/tobert/pcstat">pcstat</a> can help understand how well the
system is caching:</li>
</ul>

<pre><code>./pcstat /kafka/data/*
</code></pre>

<hr />

<p>Any comments or suggestions are welcome!</p>

          </div>
        </div>
      </div>
    </article>

    <script src="/js/highlight.pack.js"></script>
<script src="/js/quicklink.umd.js"></script>
<script src="/js/lazyload.min.js"></script>
<script>
  var lazyImage = new LazyLoad({
    container: document.getElementById('article')
  });
</script>

<script>
  hljs.initHighlightingOnLoad();

  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>

    

  </body>
</html>
