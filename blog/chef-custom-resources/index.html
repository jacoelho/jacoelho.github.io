<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta name="generator" content="Hugo 0.54.0" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Jose Coelho" />
  <meta property="og:url" content="https://www.jacoelho.com/blog/chef-custom-resources/" />
  <link rel="canonical" href="https://www.jacoelho.com/blog/chef-custom-resources/" /><script type="application/ld+json">
  {
      "@context" : "http://schema.org",
      "@type" : "BlogPosting",
      "mainEntityOfPage": {
           "@type": "WebPage",
           "@id": "https://www.jacoelho.com"
      },
      "articleSection" : "blog",
      "name" : "Chef Custom Resources ",
      "headline" : "Chef Custom Resources ",
      "description" : "Chef Custom Resources Lately I’ve been writing some Chef code. One of the best things about Chef is custom resources: https://docs.chef.io/custom_resources.html
Let’s see an example on how to create a Kafka topic using Chef and how to make it idempotent.
Before writing any Chef code it is important to understand how to manage a topic (grouping of messages of a similar type).
From the Kafka install directory, first check if the topic already exists:",
      "inLanguage" : "en-US",
      "author" : "Jose Coelho",
      "creator" : "Jose Coelho",
      "publisher": "Jose Coelho",
      "accountablePerson" : "Jose Coelho",
      "copyrightHolder" : "Jose Coelho",
      "copyrightYear" : "2016",
      "datePublished": "2016-07-13 10:24:46 &#43;0000 UTC",
      "dateModified" : "2016-07-13 10:24:46 &#43;0000 UTC",
      "url" : "https://www.jacoelho.com/blog/chef-custom-resources/",
      "keywords" : [  ]
  }
</script>
<title>Chef Custom Resources  - Jose Coelho</title>
  <meta property="og:title" content="Chef Custom Resources  - Jose Coelho" />
  <meta property="og:type" content="article" />
  <meta name="description" content="Chef Custom Resources Lately I’ve been writing some Chef code. One of the best things about Chef is custom resources: https://docs.chef.io/custom_resources.html
Let’s see an example on how to create a Kafka topic using Chef and how to make it idempotent.
Before writing any Chef code it is important to understand how to manage a topic (grouping of messages of a similar type).
From the Kafka install directory, first check if the topic already exists:" />

  <link
    rel="stylesheet"
    href="/css/flexboxgrid.min.css"
  />
  <link
    rel="stylesheet"
    href="/css/highlight/dracula.min.css"
  />
  <link rel="stylesheet" href="/css/index.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Jose Coelho">
  
  <script>
    

    (function(undefined) {}).call('object' === typeof window && window || 'object' === typeof self && self || 'object' === typeof global && global || {});
  </script>

  
</head>


  <body>
    <article class="post " id="article">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2 col-lg-6 col-lg-offset-3">
          <header class="post-header">
            <h1 class="post-title">Chef Custom Resources </h1>
            <div class="row">
              <div class="col-xs-6">
                <time class="post-date" datetime="2016-07-13 10:24:46 UTC">
                  13 Jul 2016
                </time>
              </div>
              <div class="col-xs-6">
                <div class="post-author">
                  <a target="_blank" href="https://joway.io/">@Jose Coelho</a>
                </div>
              </div>
            </div>
          </header>

          <div class="post-content markdown-body">
            

<h1 id="chef-custom-resources">Chef Custom Resources</h1>

<p>Lately I’ve been writing some <em>Chef</em> code. One of the best things about <em>Chef</em>
is custom resources:
<a href="https://docs.chef.io/custom_resources.html">https://docs.chef.io/custom_resources.html</a></p>

<p>Let’s see an example on how to create a <a href="https://kafka.apache.org/">Kafka</a> topic
using <em>Chef</em> and how to make it
<a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a>.</p>

<p>Before writing any <em>Chef</em> code it is important to understand how to manage a
<em>topic</em> (grouping of messages of a similar type).</p>

<p>From the <em>Kafka</em> install directory, first check if the <em>topic</em> already exists:</p>

<pre><code>bin/kafka-topics.sh
    --zookeeper localhost:2181 \
    --describe \
    --topic &lt;name&gt;
</code></pre>

<p>If it doesn&rsquo;t exist, create it:</p>

<pre><code>bin/kafka-topics.sh
    --zookeeper localhost:2181 \
    --create \
    --topic &lt;name&gt; \
    --replication-factor &lt;value&gt; \
    --partitions &lt;value&gt;
</code></pre>

<p>If the <em>topic</em> exists, to increase the number of <em>partitions</em> (way to
parallelize the consumption of messages from a topic):</p>

<pre><code>bin/kafka-topics.sh
    --zookeeper localhost:2181 \
    --alter \
    --topic &lt;name&gt; \
    --partitions &lt;value&gt;
</code></pre>

<p>If the topic exists, to increase the number of *replicas *(number of copies of
the partitions for data redundancy):</p>

<pre><code>bin/kafka-reassign-partitions.sh \
    --zookeeper localhost:2181 \
    --reassignment-json-file increase-replication-factor.json \
    --execute
</code></pre>

<p>Where the file <em>increase-replication-factor.json</em> follows the format:</p>

<pre><code>{
    &quot;version&quot;: 1,
    &quot;partitions&quot;: [
        {
        &quot;topic&quot;:&quot;foo&quot;,
        &quot;partition&quot;: 0,
        &quot;replicas&quot;:[1, 2, 3]
        }
    ]
}
</code></pre>

<p>The basic custom resource structure:</p>

<pre><code class="language-ruby">
property :topic,      String, name_property: true
property :partitions, Fixnum, default: 3
property :replicas,   Fixnum, default: 3
property :zookeeper,  String, default: &quot;localhost:2181&quot;
property :directory,  String, default: &quot;/kafka&quot;

action :create do
  cmd = %W(
    #{directory}/bin/kafka-topics.sh
    --zookeeper #{zookeeper}
    --create
    --topic #{topic}
    --replication-factor #{replicas}
    --partitions #{partitions}
  ).join(&quot; &quot;)

  result = shell_out(cmd)
end
</code></pre>

<p>Using the resource (<a href="https://docs.chef.io/cookbooks.html">cookbook</a> example):</p>

<pre><code class="language-ruby">example_topic &quot;example&quot; do
  partitions  1
  replication 1
end
</code></pre>

<p>With this code creating <em>topics</em> is possible. However, it isn’t checking if the
topic already exists or if the settings are valid.</p>

<hr />

<h4 id="chefspec">ChefSpec</h4>

<p><a href="https://github.com/sethvargo/chefspec">ChefSpec</a> is a testing framework aimed
for testing <em>Chef</em> cookbooks.</p>

<p>In order to test a custom resource, first create the <em>ChefSpec</em> resource
matcher:</p>

<pre><code class="language-ruby">if defined?(ChefSpec)

  def create_example_topic(resource_name)
    ChefSpec::Matchers::ResourceMatcher.new(:example_topic, :create, resource_name)
  end

end
</code></pre>

<p>Generate a <em>test_cookbook</em>:</p>

<pre><code>mkdir -p test/cookbooks
chef generate cookbook test/cookbooks/test_example
</code></pre>

<p>Create the file* test/cookbooks/test_example/recipes/create.rb*:</p>

<pre><code class="language-ruby">example_topic &quot;example&quot; do
  partitions  1
  replication 1
end
</code></pre>

<p>Update the file <em>test/cookbooks/test_example/metadata.rb</em>:</p>

<pre><code class="language-ruby">name &quot;test_example&quot;
maintainer &quot;The Authors&quot;
maintainer_email &quot;you@example.com&quot;
license &quot;all_rights&quot;
description &quot;Installs/Configures test&quot;
long_description &quot;Installs/Configures test&quot;
version &quot;0.1.0&quot;

depends &quot;example&quot; # example cookbook dependency
</code></pre>

<p>Write the create test <em>spec/unit/recipes/create_spec.rb</em>:</p>

<pre><code class="language-ruby">require &quot;spec_helper&quot;

context &quot;test_example&quot; do
  let(:chef_conf) do
    ChefSpec::SoloRunner.new cookbook_path: %w(./test/cookbooks ../), # import test and example cookbook
                             step_into:     %w(example_topic) # dive inside example_topic
  end

  let(:shellout) { double(&quot;shellout&quot;) } # setup shellout double

  before do
    allow(Mixlib::ShellOut).to receive(:new).and_return(shellout)
    allow(shellout).to receive_messages(
      :run_command =&gt; nil,
      :error! =&gt; nil,
      :live_stream =&gt; nil,
      :live_stream= =&gt; nil
    )
  end

  describe &quot;topic create&quot; do
    let(:chef_run) { chef_conf.converge(&quot;test_example::create&quot;) }

    it &quot;converges successfully&quot; do
      allow(shellout).to receive(:stdout).and_return(&quot;&quot;, &quot;Created topic&quot;)

      expect { chef_run }.to_not raise_error
      expect(chef_run).to create_example_topic(&quot;test&quot;) # custom matcher in action
    end
  end
</code></pre>

<p>Now we can improve our resource with confidence — and all will still be working!</p>

<hr />

<p>At the moment the resource is quite simple and will try to create the topic
every time <em>Chef</em> runs. Now it’s time to find ways to improve it!</p>

<p>As seen before we can search for a <em>topic</em>:</p>

<pre><code>bin/kafka-topics.sh
    --zookeeper $ZK \
    --describe \
    --topic &lt;name&gt;
</code></pre>

<p>The output will be something like:</p>

<p><img src="https://cdn-images-1.medium.com/max/1600/1*ilfBGZvftKO0a8ljO2nx8g.png" alt="" />
<span class="figcaption_hack">kafka describe topic</span></p>

<p>Example code to parse this output:</p>

<pre><code class="language-ruby">def list(directory, zookeeper, topic)
  cmd = %W(
    #{directory}/bin/kafka-topics.sh
    --zookeeper #{zookeeper}
    --describe
    --topic #{topic}
  ).join(&quot; &quot;)

  result = shell_out(cmd).stdout
  extract = -&gt;(a) { a &amp;&amp; a.to_i }

  {
    partitions: extract.call(result[/PartitionCount:\s*(\d+)/, 1]),
    replicas: extract.call(result[/ReplicationFactor:\s*(\d+)/, 1])
  }
end
</code></pre>

<p>With this we create a consistent view between <em>Chef</em> and the actual resource:</p>

<pre><code class="language-ruby">load_current_value do
  current_partitions, current_replicas = list(directory, zookeeper, topic)
                                         .values_at *%w(partitions replicas)

  current_value_does_not_exist! unless current_partitions &amp;&amp; current_replicas

  partitions current_partitions
  replicas current_replicas
end
</code></pre>

<p>Refactoring the “*create action*”:</p>

<pre><code class="language-ruby">action :create do
  # calls the block if current_resource does not exist
  # or values are different from current_resource
  converge_if_changed do
    if current_resource
      action_update
    else
      converge_by &quot;Create topic #{new_resource.topic}&quot; do
        create! new_resource.directory,
                new_resource.zookeeper,
                new_resource.topic,
                new_resource.partitions,
                new_resource.replicas
      end
    end
  end
end
</code></pre>

<p>“*Update action*”:</p>

<pre><code class="language-ruby">action :update do
  alter! new_resource.directory,
         new_resource.zookeeper,
         new_resource.topic,
         new_resource.partitions
end

require &quot;chef/log&quot;

def alter!(directory, zookeeper, topic, partitions)
  cmd = %W(
    #{directory}/bin/kafka-topics.sh
    --zookeeper #{zookeeper}
    --alter
    --topic #{topic}
    --partitions #{partitions}
  ).join(&quot; &quot;)

  result = shell_out(cmd)
  Chef::Log.error(result.stderr) unless result.stdout =~ /Adding partitions succeeded!/
end
</code></pre>

<p>This small example goes to show just how powerful the <em>Chef</em> <em>DSL</em> is and how it
helps in the creation of idempotent resources.</p>

<p>The full example (with tests) is available in the github:
<a href="https://github.com/jacoelho/example">link</a></p>

          </div>
        </div>
      </div>
    </article>

    <script src="/js/highlight.pack.js"></script>
<script src="/js/quicklink.umd.js"></script>
<script src="/js/lazyload.min.js"></script>
<script>
  var lazyImage = new LazyLoad({
    container: document.getElementById('article')
  });
</script>

<script>
  hljs.initHighlightingOnLoad();

  var posts = document.getElementById('posts-list');
  posts && quicklink({
    el: posts,
    priority: true,
  });
</script>

    

  </body>
</html>
