<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Jose Coelho"><meta name=description content="Ramblings about software engineering"><meta name=keywords content="go,golang,kubernetes,ansible,chef,kafka,docker,containers"><link rel=canonical href=https://www.jacoelho.com/blog/2025/05/dependency-lifecycle-management-in-go/><title>Dependency Lifecycle Management in Go :: Posts</title><link rel=stylesheet href=https://www.jacoelho.com/css/main.min.6f3353616359b0fe4cfe1d29dc41b46980dd1459838e2e6175f34881197cc945.css integrity="sha256-bzNTYWNZsP5M/h0p3EG0aYDdFFmDji5hdfNIgRl8yUU=" crossorigin=anonymous><meta itemprop=name content="Dependency Lifecycle Management in Go"><meta itemprop=description content="Introduction Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped.
Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.
As applications scale, the lack of built-in orchestration increases the risk of subtle bugs and inconsistent shutdown behavior."><meta itemprop=datePublished content="2025-05-11T10:00:00+00:00"><meta itemprop=dateModified content="2025-05-11T10:00:00+00:00"><meta itemprop=wordCount content="1518"><meta itemprop=keywords content="Go,Golang,Dependency Injection,Dependency Lifecycle,Di"><meta property="og:url" content="https://www.jacoelho.com/blog/2025/05/dependency-lifecycle-management-in-go/"><meta property="og:site_name" content="Posts"><meta property="og:title" content="Dependency Lifecycle Management in Go"><meta property="og:description" content="Introduction Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped.
Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.
As applications scale, the lack of built-in orchestration increases the risk of subtle bugs and inconsistent shutdown behavior."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2025-05-11T10:00:00+00:00"><meta property="article:modified_time" content="2025-05-11T10:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dependency Lifecycle Management in Go"><meta name=twitter:description content="Introduction Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped.
Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.
As applications scale, the lack of built-in orchestration increases the risk of subtle bugs and inconsistent shutdown behavior."><meta property="article:published_time" content="2025-05-11 10:00:00 +0000 UTC"><meta property="article:section" content="go"><meta property="article:section" content="golang"><meta property="article:section" content="dependency injection"><meta property="article:section" content="dependency lifecycle"><meta property="article:section" content="di"></head><body><header class=header><div class=container><div class=header-inner><a href=https://www.jacoelho.com/ class=logo>Jose Coelho</a><nav class=nav><button class=menu-trigger aria-label="Toggle menu" aria-expanded=false>
<svg width="24" height="24"><use href="https://www.jacoelho.com/icons.svg#menu"/></svg></button><div class=nav-menu><ul class=menu><li class=menu-item><a href=https://www.jacoelho.com/about/>About</a></li></ul><button class=theme-toggle aria-label="Toggle theme">
<svg class="theme-icon-light" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#sun"/></svg>
<svg class="theme-icon-dark" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#moon"/></svg>
</button>
<a href=https://www.jacoelho.com/index.xml class=rss-link target=_blank rel=noopener aria-label=RSS><svg width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#rss"/></svg></a></div></nav></div></div></header><div class=container><div class=content><main class=post><article><header class=post-header><h1 class=post-title>Dependency Lifecycle Management in Go</h1></header><div class=post-content><h2 id=introduction>Introduction</h2><p>Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped.</p><p>Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.</p><p>As applications scale, the lack of built-in orchestration increases the risk of subtle bugs and inconsistent shutdown behavior.</p><p>This post compares two approaches:</p><ul><li><strong>Manual lifecycle management</strong> using idiomatic Go</li><li><strong>Structured lifecycle management</strong> using the <a href=https://github.com/jacoelho/component><code>component</code></a> library</li></ul><h2 id=understanding-dependency-lifecycle-in-go>Understanding Dependency Lifecycle in Go</h2><p>In Go applications, services such as HTTP servers, database connections, and background workers often have dependencies that must be managed explicitly. While Go provides primitives like <code>context.Context</code> and <code>sync.WaitGroup</code>, it is the developer’s responsibility to ensure that resources are constructed, started, and shut down in the correct order.</p><p>This coordination becomes more challenging as dependencies grow in number and interdependence. Without a structured lifecycle model, it’s easy to overlook teardown responsibilities, introduce race conditions, or mishandle cancellation flows.</p><h2 id=manual-dependency-wiring>Manual Dependency Wiring</h2><p>In idiomatic Go, managing the lifecycle of an HTTP server involves handling OS signals, propagating context cancellations, and ensuring that all resources are released properly. Here&rsquo;s an enhanced example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>stop</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>signal</span><span class=p>.</span><span class=nf>NotifyContext</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGINT</span><span class=p>,</span><span class=w> </span><span class=nx>syscall</span><span class=p>.</span><span class=nx>SIGTERM</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>httpCtx</span><span class=p>,</span><span class=w> </span><span class=nx>httpCancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>srv</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Server</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Addr</span><span class=p>:</span><span class=w>    </span><span class=s>&#34;:8080&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>Handler</span><span class=p>:</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>DefaultServeMux</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>BaseContext</span><span class=p>:</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Listener</span><span class=p>)</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=nx>httpCtx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=nx>wg</span><span class=w> </span><span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Start HTTP server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>defer</span><span class=w> </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>srv</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>();</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>!</span><span class=nx>errors</span><span class=p>.</span><span class=nf>Is</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>ErrServerClosed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;server failed: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Start a worker that simulates queue processing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>workerCtx</span><span class=p>,</span><span class=w> </span><span class=nx>workerCancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>go</span><span class=w> </span><span class=kd>func</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>defer</span><span class=w> </span><span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>for</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>select</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>case</span><span class=w> </span><span class=o>&lt;-</span><span class=nx>workerCtx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;worker stopped&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;processing queue item&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;server and worker started&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;shutdown signal received&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Initiate graceful shutdown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>shutdownCtx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span><span class=w> </span><span class=mi>5</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>srv</span><span class=p>.</span><span class=nf>Shutdown</span><span class=p>(</span><span class=nx>shutdownCtx</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;graceful shutdown failed: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>httpCancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nf>workerCancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;shutdown complete&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This example demonstrates how to manage the startup and shutdown of multiple services, specifically an HTTP server and a background worker using idiomatic Go patterns:</p><ul><li><p><strong>Signal Handling</strong><br>The application listens for system interrupts (<code>SIGINT</code>, <code>SIGTERM</code>) using <code>signal.NotifyContext</code>. When a signal is received, the context is canceled, triggering shutdown logic.</p></li><li><p><strong>HTTP Server Setup</strong><br>A standard <code>http.Server</code> is initialized with a base context (<code>httpCtx</code>) that can be canceled independently. This allows graceful termination of incoming requests.</p></li><li><p><strong>Background Worker</strong><br>A simulated worker runs in a separate goroutine. It processes tasks (logged every second) until its context (<code>workerCtx</code>) is canceled.</p></li><li><p><strong>WaitGroup Coordination</strong><br>A <code>sync.WaitGroup</code> tracks both the HTTP server and worker goroutines. This ensures the main function blocks until all background work completes during shutdown.</p></li><li><p><strong>Shutdown Flow</strong><br>Upon receiving a signal:</p><ul><li>A shutdown context (<code>shutdownCtx</code>) with a timeout is created for the HTTP server.</li><li>The HTTP server is gracefully shut down.</li><li>Both contexts (<code>httpCancel</code>, <code>workerCancel</code>) are canceled to signal termination.</li><li>The main function waits (<code>wg.Wait()</code>) until both goroutines finish cleanly.</li></ul></li></ul><h3 id=pros>Pros</h3><ul><li>No external dependencies</li><li>Full control over orchestration</li></ul><h3 id=cons>Cons</h3><ul><li>Lifecycle logic is scattered</li><li>Harder to test in isolation</li><li>Cleanup sequencing becomes complex with multiple services</li></ul><h3 id=challenges-with-start-and-shutdown-order>Challenges with Start and Shutdown Order</h3><p>Coordinating startup and shutdown is deceptively complex. While Go offers simple primitives, their correct use requires consistent discipline, especially as systems scale.</p><h4 id=common-pitfalls>Common Pitfalls</h4><ul><li><strong>Deferred cleanup runs in reverse</strong>: This works well when initialization and teardown are co-located, but can lead to premature shutdown when resources depend on one another.</li><li><strong>Context cancellation doesn&rsquo;t wait</strong>: <code>context.Context</code> can signal termination, but it doesn’t block until goroutines exit. Without explicit coordination (e.g., <code>sync.WaitGroup</code>), shutdown may race ahead of in-flight tasks.</li><li><strong>Detached lifecycle ownership</strong>: When components are initialized in helper functions without returning their cleanup responsibilities, it&rsquo;s easy to overlook or misorder shutdown steps.</li></ul><p>These problems compound in systems with interdependent services. For example, if a worker enqueues jobs to a queue and a processor persists them to a database, shutting down the processor first risks losing data. Such errors are subtle, hard to test for, and difficult to recover from.</p><p>Despite Go&rsquo;s concurrency primitives, lifecycle correctness remains the developer&rsquo;s responsibility and a source of subtle bugs if not handled carefully.</p><h2 id=using-the-component-library>Using the <code>component</code> Library</h2><p>The <a href=https://github.com/jacoelho/component><code>component</code></a> library offers a minimal framework for structuring and orchestrating stateful services in Go. It builds on Go&rsquo;s type system and concurrency primitives to manage component initialization and shutdown in a clear, predictable order.</p><p>Components are registered with explicit dependencies and organized into levels in a directed acyclic graph (DAG). The library starts and stops components in dependency respecting order, in parallel where safe. If startup fails, it automatically rolls back by stopping already started components.</p><p>A component implements <code>Lifecycle</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Lifecycle</span><span class=w> </span><span class=kd>interface</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Start</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>Stop</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Components are registered with a <code>System</code>, which handles lifecycle sequencing:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;context&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;time&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;github.com/jacoelho/component&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 1. Define components</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Logger</span><span class=w> </span><span class=kd>struct</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>l</span><span class=w> </span><span class=o>*</span><span class=nx>Logger</span><span class=p>)</span><span class=w> </span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=nx>l</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;Logger Started&#34;</span><span class=p>);</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>l</span><span class=w> </span><span class=o>*</span><span class=nx>Logger</span><span class=p>)</span><span class=w> </span><span class=nf>Stop</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w>  </span><span class=p>{</span><span class=w> </span><span class=nx>l</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;Logger Stopped&#34;</span><span class=p>);</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>l</span><span class=w> </span><span class=o>*</span><span class=nx>Logger</span><span class=p>)</span><span class=w> </span><span class=nf>Log</span><span class=p>(</span><span class=nx>message</span><span class=w> </span><span class=kt>string</span><span class=p>)</span><span class=w>              </span><span class=p>{</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>MainService</span><span class=w> </span><span class=kd>struct</span><span class=p>{</span><span class=w> </span><span class=nx>logger</span><span class=w> </span><span class=o>*</span><span class=nx>Logger</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>MainService</span><span class=p>)</span><span class=w> </span><span class=nf>Start</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;MainService Started&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>MainService</span><span class=p>)</span><span class=w> </span><span class=nf>Stop</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>s</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nf>Log</span><span class=p>(</span><span class=s>&#34;MainService Stopped&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>sys</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nb>new</span><span class=p>(</span><span class=nx>component</span><span class=p>.</span><span class=nx>System</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>ctx</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Create Keys</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=kd>var</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>loggerKey</span><span class=w>  </span><span class=nx>component</span><span class=p>.</span><span class=nx>Key</span><span class=p>[</span><span class=o>*</span><span class=nx>Logger</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>serviceKey</span><span class=w> </span><span class=nx>component</span><span class=p>.</span><span class=nx>Key</span><span class=p>[</span><span class=o>*</span><span class=nx>MainService</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Provide components</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>component</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>sys</span><span class=p>,</span><span class=w> </span><span class=nx>loggerKey</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>_</span><span class=w> </span><span class=o>*</span><span class=nx>component</span><span class=p>.</span><span class=nx>System</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Logger</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>Logger</span><span class=p>{},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>});</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to provide logger: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>component</span><span class=p>.</span><span class=nf>Provide</span><span class=p>(</span><span class=nx>sys</span><span class=p>,</span><span class=w> </span><span class=nx>serviceKey</span><span class=p>,</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>component</span><span class=p>.</span><span class=nx>System</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>MainService</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>logger</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>component</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span><span class=w> </span><span class=nx>loggerKey</span><span class=p>)</span><span class=w> </span><span class=c1>// Get dependency</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=nx>MainService</span><span class=p>{</span><span class=nx>logger</span><span class=p>:</span><span class=w> </span><span class=nx>logger</span><span class=p>},</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>},</span><span class=w> </span><span class=nx>loggerKey</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// Declare dependency on loggerKey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to provide main service: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Start system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Starting system...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>startCtx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=o>*</span><span class=mi>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sys</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>startCtx</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;System start failed: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;System is UP.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// Stop system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Stopping system...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>stopCtx</span><span class=p>,</span><span class=w> </span><span class=nx>cancel</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=o>*</span><span class=mi>5</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>defer</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>sys</span><span class=p>.</span><span class=nf>Stop</span><span class=p>(</span><span class=nx>stopCtx</span><span class=p>);</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;System stop encountered errors: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;System shut down.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This example shows how to explicitly declare dependencies between services and let the library orchestrate their lifecycle.</p><h4 id=key-concepts>Key Concepts</h4><ul><li><p><strong>Component System (<code>component.System</code>)</strong><br>This is the central registry. It tracks all components and their dependencies. It is responsible for starting and stopping components in the correct order.</p></li><li><p><strong>Component Keys</strong><br><code>component.Key[*Logger]</code> and <code>component.Key[*MainService]</code> serve as unique identifiers for each registered component. These keys are used for dependency lookup and resolution.</p></li><li><p><strong>Providing Components</strong><br>Components are registered using <code>component.Provide</code>, which takes:</p><ul><li>The system</li><li>A key</li><li>A constructor function that may declare dependencies</li><li>Optional dependency keys (e.g., <code>loggerKey</code> for <code>MainService</code>)</li></ul><p>This allows the system to validate the dependency graph and determine start/stop order.</p></li><li><p><strong>Dependency Declaration</strong><br><code>MainService</code> depends on <code>Logger</code>, which is declared via the constructor and enforced by passing <code>loggerKey</code> to <code>Provide</code>.</p></li><li><p><strong>Start and Stop Lifecycle</strong><br><code>sys.Start(ctx)</code> starts all components in topological order based on their dependencies. In this case:</p><ol><li><code>Logger</code> starts first.</li><li><code>MainService</code> starts second (after <code>Logger</code> is ready).</li></ol><p><code>sys.Stop(ctx)</code> shuts down components in reverse order.</p></li></ul><p>This pattern eliminates manual wiring of start/stop logic and enforces correct ordering via explicit dependency declarations. It’s scalable, testable, and safe, especially as the number of components grows.</p><p>While the example is minimal, it mirrors patterns used in production systems to manage databases, queues, servers, and background jobs with consistent lifecycle semantics.</p><h3 id=pros-1>Pros</h3><ul><li><strong>Explicit Dependency Declaration</strong>: Each component clearly defines what it needs, reducing hidden coupling.</li><li><strong>Automatic Lifecycle Ordering</strong>: Components start and stop respecting dependency order, reducing shutdown bugs.</li><li><strong>Centralized Lifecycle Management</strong>: The <code>System</code> handles orchestration, improving maintainability and testability.</li><li><strong>Parallel Execution</strong>: Components at the same dependency level start concurrently, improving efficiency.</li><li><strong>Validation at Registration</strong>: The system catches cyclic dependencies early.</li></ul><h3 id=cons-1>Cons</h3><ul><li><strong>Extra Abstraction Layer</strong>: Adds structural overhead compared to manually wiring functions and structs.</li><li><strong>Less Transparent for Simple Cases</strong>: For small programs, the indirection can obscure the flow of control and increase conceptual overhead.</li><li><strong>Runtime Wiring Overhead</strong>: Dependencies are resolved at runtime, not at compile time, which may be unfamiliar to Go developers used to static wiring.</li></ul><h2 id=conclusion>Conclusion</h2><p>Manual lifecycle management in Go works well for smaller applications with simple dependencies. It keeps the control flow clear and aligns with Go&rsquo;s preference for direct, explicit code. But as more components are added, each with their own startup and shutdown requirements, manual wiring becomes more difficult to maintain and more likely to break.</p><p>The component library helps manage this complexity by introducing a structure for declaring and orchestrating components. It handles dependency resolution, startup sequencing, and shutdown ordering automatically. This reduces boilerplate and improves the reliability of long running systems without hiding too much logic or requiring major changes to Go&rsquo;s usual patterns.</p><p>For teams working on modular or service-heavy systems, component provides a practical way to scale lifecycle management while preserving the clarity and maintainability expected in Go projects.</p></div></article></main></div></div><footer class=footer><div class=container><div class=footer-content><span>&copy; 2025 Jose Coelho</span></div></div></footer><script src=https://www.jacoelho.com/js/bundle.min.c687f63d8e204d7466c7c9609ec6f61b44c1217490b36198e5f77ee3befc11ea.js integrity="sha256-xof2PY4gTXRmx8lgnsb2G0TBIXSQs2GY5fd+4778Eeo=" crossorigin=anonymous></script></body></html>