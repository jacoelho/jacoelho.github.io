<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="keywords"
    content="go, golang, kubernetes, ansible, chef, kafka, docker, containers" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="#252627" />
<meta name="description" content="Notes on building software">
<link rel="canonical" href="https://www.jacoelho.com/blog/2025/05/dependency-lifecycle-management-in-go/" />


<title>
    
    Dependency Lifecycle Management in Go :: Posts 
    
</title>





<link rel="stylesheet" href="https://www.jacoelho.com/main.min.83e433d285f1a569e54dc9705b02c8c0c8fd81be6c274aa542a3321903fa24b5.css" integrity="sha256-g&#43;Qz0oXxpWnlTclwWwLIwMj9gb5sJ0qlQqMyGQP6JLU=" crossorigin="anonymous">






    <link rel="apple-touch-icon" sizes="180x180" href="https://www.jacoelho.com/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://www.jacoelho.com/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://www.jacoelho.com/favicon-16x16.png">
    <link rel="mask-icon" href="https://www.jacoelho.com/safari-pinned-tab.svg" color="#252627">
    <link rel="shortcut icon" href="https://www.jacoelho.com/favicon.ico">
    <meta name="msapplication-TileColor" content="#252627">
    <meta name="theme-color" content="#252627">



  <meta itemprop="name" content="Dependency Lifecycle Management in Go">
  <meta itemprop="description" content="Introduction Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped. This is particularly critical in long-running applications where improper shutdowns can result in resource leaks, data loss, or inconsistent states.
Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.">
  <meta itemprop="datePublished" content="2025-05-11T10:00:00+00:00">
  <meta itemprop="dateModified" content="2025-05-11T10:00:00+00:00">
  <meta itemprop="wordCount" content="1589">
  <meta itemprop="image" content="https://www.jacoelho.com/">
  <meta itemprop="keywords" content="Go,Golang,Dependency Injection,Dependency Lifecycle,Di">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://www.jacoelho.com/">
  <meta name="twitter:title" content="Dependency Lifecycle Management in Go">
  <meta name="twitter:description" content="Introduction Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped. This is particularly critical in long-running applications where improper shutdowns can result in resource leaks, data loss, or inconsistent states.
Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.">



<meta property="og:url" content="https://www.jacoelho.com/blog/2025/05/dependency-lifecycle-management-in-go/">
  <meta property="og:site_name" content="Posts">
  <meta property="og:title" content="Dependency Lifecycle Management in Go">
  <meta property="og:description" content="Introduction Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped. This is particularly critical in long-running applications where improper shutdowns can result in resource leaks, data loss, or inconsistent states.
Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-05-11T10:00:00+00:00">
    <meta property="article:modified_time" content="2025-05-11T10:00:00+00:00">
    <meta property="og:image" content="https://www.jacoelho.com/">




<meta property="article:section" content="go" />

<meta property="article:section" content="golang" />

<meta property="article:section" content="dependency injection" />

<meta property="article:section" content="dependency lifecycle" />

<meta property="article:section" content="di" />



<meta property="article:published_time" content="2025-05-11 10:00:00 &#43;0000 UTC" />








<script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
        c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
        t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
        y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "3wjiv20hsj");
</script>
    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://www.jacoelho.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__text">Jose Coelho</span>
            <span class="logo__cursor" style=
                  "visibility:hidden;
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://www.jacoelho.com/about/">About</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
<main class="post">

    <div class="post-info">
        
        </p>
    </div>

    <article>
        <h2 class="post-title"><a href="https://www.jacoelho.com/blog/2025/05/dependency-lifecycle-management-in-go/">Dependency Lifecycle Management in Go</a></h2>

        

        

        <div class="post-content">
            <h2 id="introduction">Introduction</h2>
<p>Lifecycle management ensures that application components like servers, databases, and background workers are correctly initialized, started in the right order, and gracefully stopped. This is particularly critical in long-running applications where improper shutdowns can result in resource leaks, data loss, or inconsistent states.</p>
<p>Go developers typically wire dependencies manually, instead of relying on heavy frameworks or reflection based dependency injection. This approach improves readability and reduces hidden behavior, but it also shifts the burden of managing component interactions and lifecycle sequencing onto the developer.</p>
<p>As applications scale, the lack of built-in orchestration increases the risk of subtle bugs and inconsistent shutdown behavior.</p>
<p>This post compares two approaches:</p>
<ul>
<li><strong>Manual lifecycle management</strong> using idiomatic Go</li>
<li><strong>Structured lifecycle management</strong> using the <a href="https://github.com/jacoelho/component"><code>component</code></a> library</li>
</ul>
<p>We will examine how each approach handles initialization, startup, and teardown, and compare their trade-offs in terms of clarity, maintainability, and observability.</p>
<h2 id="understanding-dependency-lifecycle-in-go">Understanding Dependency Lifecycle in Go</h2>
<p>In Go applications, services such as HTTP servers, database connections, and background workers often have dependencies that must be managed explicitly. While Go provides primitives like <code>context.Context</code> and <code>sync.WaitGroup</code>, it is the developer’s responsibility to ensure that resources are constructed, started, and shut down in the correct order.</p>
<p>This coordination becomes more challenging as dependencies grow in number and interdependence. Without a structured lifecycle model, it’s easy to overlook teardown responsibilities, introduce race conditions, or mishandle cancellation flows.</p>
<h2 id="manual-dependency-wiring">Manual Dependency Wiring</h2>
<p>In idiomatic Go, managing the lifecycle of an HTTP server involves handling OS signals, propagating context cancellations, and ensuring that all resources are released properly. Here&rsquo;s an enhanced example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">stop</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">signal</span>.<span style="color:#a6e22e">NotifyContext</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGINT</span>, <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SIGTERM</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">stop</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">httpCtx</span>, <span style="color:#a6e22e">httpCancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Addr</span>:    <span style="color:#e6db74">&#34;:8080&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Handler</span>: <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">DefaultServeMux</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">BaseContext</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>) <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">httpCtx</span>
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start HTTP server</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">ListenAndServe</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ErrServerClosed</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;server failed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start a worker that simulates queue processing</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">workerCtx</span>, <span style="color:#a6e22e">workerCancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithCancel</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">workerCtx</span>.<span style="color:#a6e22e">Done</span>():
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;worker stopped&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;processing queue item&#34;</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;server and worker started&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;shutdown signal received&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Initiate graceful shutdown</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">shutdownCtx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">Shutdown</span>(<span style="color:#a6e22e">shutdownCtx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;graceful shutdown failed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">httpCancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">workerCancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;shutdown complete&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This example demonstrates how to manage the startup and shutdown of multiple services—specifically an HTTP server and a background worker—using idiomatic Go patterns:</p>
<ul>
<li>
<p><strong>Signal Handling</strong><br>
The application listens for system interrupts (<code>SIGINT</code>, <code>SIGTERM</code>) using <code>signal.NotifyContext</code>. When a signal is received, the context is canceled, triggering shutdown logic.</p>
</li>
<li>
<p><strong>HTTP Server Setup</strong><br>
A standard <code>http.Server</code> is initialized with a base context (<code>httpCtx</code>) that can be canceled independently. This allows graceful termination of incoming requests.</p>
</li>
<li>
<p><strong>Background Worker</strong><br>
A simulated worker runs in a separate goroutine. It processes tasks (logged every second) until its context (<code>workerCtx</code>) is canceled.</p>
</li>
<li>
<p><strong>WaitGroup Coordination</strong><br>
A <code>sync.WaitGroup</code> tracks both the HTTP server and worker goroutines. This ensures the main function blocks until all background work completes during shutdown.</p>
</li>
<li>
<p><strong>Shutdown Flow</strong><br>
Upon receiving a signal:</p>
<ul>
<li>A shutdown context (<code>shutdownCtx</code>) with a timeout is created for the HTTP server.</li>
<li>The HTTP server is gracefully shut down.</li>
<li>Both contexts (<code>httpCancel</code>, <code>workerCancel</code>) are canceled to signal termination.</li>
<li>The main function waits (<code>wg.Wait()</code>) until both goroutines finish cleanly.</li>
</ul>
</li>
</ul>
<h3 id="pros">Pros</h3>
<ul>
<li>No external dependencies</li>
<li>Full control over orchestration</li>
</ul>
<h3 id="cons">Cons</h3>
<ul>
<li>Lifecycle logic is scattered</li>
<li>Harder to test in isolation</li>
<li>Cleanup sequencing becomes complex with multiple services</li>
</ul>
<h3 id="challenges-with-start-and-shutdown-order">Challenges with Start and Shutdown Order</h3>
<p>Coordinating startup and shutdown is deceptively complex. While Go offers simple primitives, their correct use requires consistent discipline, especially as systems scale.</p>
<h4 id="common-pitfalls">Common Pitfalls</h4>
<ul>
<li><strong>Deferred cleanup runs in reverse</strong>: This works well when initialization and teardown are co-located, but can lead to premature shutdown when resources depend on one another.</li>
<li><strong>Context cancellation doesn&rsquo;t wait</strong>: <code>context.Context</code> can signal termination, but it doesn’t block until goroutines exit. Without explicit coordination (e.g., <code>sync.WaitGroup</code>), shutdown may race ahead of in-flight tasks.</li>
<li><strong>Detached lifecycle ownership</strong>: When components are initialized in helper functions without returning their cleanup responsibilities, it&rsquo;s easy to overlook or misorder shutdown steps.</li>
</ul>
<p>These problems compound in systems with interdependent services. For example, if a worker enqueues jobs to a queue and a processor persists them to a database, shutting down the processor first risks losing data. Such errors are subtle, hard to test for, and difficult to recover from.</p>
<p>Despite Go&rsquo;s concurrency primitives, lifecycle correctness remains the developer&rsquo;s responsibility and a source of subtle bugs if not handled carefully.</p>
<h2 id="using-the-component-library">Using the <code>component</code> Library</h2>
<p>The <a href="https://github.com/jacoelho/component"><code>component</code></a> library offers a minimal framework for structuring and orchestrating stateful services in Go. It builds on Go&rsquo;s type system and concurrency primitives to manage component initialization and shutdown in a clear, predictable order.</p>
<p>Components are registered with explicit dependencies and organized into levels in a directed acyclic graph (DAG). The library starts and stops components in dependency-respecting order, in parallel where safe. If startup fails, it automatically rolls back by stopping already-started components.</p>
<p>A component implements <code>Lifecycle</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Lifecycle</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Components are registered with a <code>System</code>, which handles lifecycle sequencing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/jacoelho/component&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 1. Define components</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Logger</span> <span style="color:#66d9ef">struct</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> { <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;Logger Started&#34;</span>); <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span>  { <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;Logger Stopped&#34;</span>); <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">l</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Logger</span>) <span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">message</span> <span style="color:#66d9ef">string</span>)              { <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">message</span>) }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MainService</span> <span style="color:#66d9ef">struct</span>{ <span style="color:#a6e22e">logger</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Logger</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MainService</span>) <span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;MainService Started&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MainService</span>) <span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;MainService Stopped&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sys</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">System</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Create Keys</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">loggerKey</span>  <span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">Key</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">Logger</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">serviceKey</span> <span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">Key</span>[<span style="color:#f92672">*</span><span style="color:#a6e22e">MainService</span>]
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Provide components</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">Provide</span>(<span style="color:#a6e22e">sys</span>, <span style="color:#a6e22e">loggerKey</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">_</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">System</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Logger</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Logger</span>{}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Failed to provide logger: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">Provide</span>(<span style="color:#a6e22e">sys</span>, <span style="color:#a6e22e">serviceKey</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">System</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">MainService</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">component</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">loggerKey</span>) <span style="color:#75715e">// Get dependency</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MainService</span>{<span style="color:#a6e22e">logger</span>: <span style="color:#a6e22e">logger</span>}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}, <span style="color:#a6e22e">loggerKey</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> { <span style="color:#75715e">// Declare dependency on loggerKey</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Failed to provide main service: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Start system</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Starting system...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">startCtx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">startCtx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;System start failed: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;System is UP.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Stop system</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Stopping system...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stopCtx</span>, <span style="color:#a6e22e">cancel</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithTimeout</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span><span style="color:#f92672">*</span><span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">cancel</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sys</span>.<span style="color:#a6e22e">Stop</span>(<span style="color:#a6e22e">stopCtx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;System stop encountered errors: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;System shut down.&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This example demonstrates how to define and manage application components using the <a href="https://github.com/jacoelho/component"><code>component</code></a> library. It shows how to explicitly declare dependencies between services and let the library orchestrate their lifecycle.</p>
<h4 id="key-concepts">Key Concepts</h4>
<ul>
<li>
<p><strong>Component System (<code>component.System</code>)</strong><br>
This is the central registry. It tracks all components and their dependencies. It is responsible for starting and stopping components in the correct order.</p>
</li>
<li>
<p><strong>Component Keys</strong><br>
<code>component.Key[*Logger]</code> and <code>component.Key[*MainService]</code> serve as unique identifiers for each registered component. These keys are used for dependency lookup and resolution.</p>
</li>
<li>
<p><strong>Providing Components</strong><br>
Components are registered using <code>component.Provide</code>, which takes:</p>
<ul>
<li>The system</li>
<li>A key</li>
<li>A constructor function that may declare dependencies</li>
<li>Optional dependency keys (e.g., <code>loggerKey</code> for <code>MainService</code>)</li>
</ul>
<p>This allows the system to validate the dependency graph and determine start/stop order.</p>
</li>
<li>
<p><strong>Dependency Declaration</strong><br>
<code>MainService</code> depends on <code>Logger</code>, which is declared via the constructor and enforced by passing <code>loggerKey</code> to <code>Provide</code>.</p>
</li>
<li>
<p><strong>Start and Stop Lifecycle</strong><br>
<code>sys.Start(ctx)</code> starts all components in topological order based on their dependencies. In this case:</p>
<ol>
<li><code>Logger</code> starts first.</li>
<li><code>MainService</code> starts second (after <code>Logger</code> is ready).</li>
</ol>
<p><code>sys.Stop(ctx)</code> shuts down components in reverse order.</p>
</li>
<li>
<p><strong>Timeout Contexts</strong><br>
The system is started and stopped with <code>context.WithTimeout</code>, giving each operation up to 5 seconds to complete cleanly.</p>
</li>
</ul>
<p>This pattern eliminates manual wiring of start/stop logic and enforces correct ordering via explicit dependency declarations. It’s scalable, testable, and safe—especially as the number of components grows.</p>
<p>While the example is minimal, it mirrors patterns used in production systems to manage databases, queues, servers, and background jobs with consistent lifecycle semantics.</p>
<h3 id="pros-1">Pros</h3>
<ul>
<li><strong>Explicit Dependency Declaration</strong>: Each component clearly defines what it needs, reducing hidden coupling.</li>
<li><strong>Automatic Lifecycle Ordering</strong>: Components start and stop in dependency-respecting order, reducing shutdown bugs.</li>
<li><strong>Centralized Lifecycle Management</strong>: The <code>System</code> handles orchestration, improving maintainability and testability.</li>
<li><strong>Parallel Execution</strong>: Components at the same dependency level start concurrently, improving efficiency.</li>
<li><strong>Validation at Registration</strong>: The system catches missing or cyclic dependencies early.</li>
</ul>
<h3 id="cons-1">Cons</h3>
<ul>
<li><strong>Extra Abstraction Layer</strong>: Adds structural overhead compared to manually wiring functions and structs.</li>
<li><strong>Less Transparent for Simple Cases</strong>: For small programs, the indirection can obscure the flow of control and increase conceptual overhead.</li>
<li><strong>Runtime Wiring Overhead</strong>: Dependencies are resolved at runtime, not at compile time, which may be unfamiliar to Go developers used to static wiring.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Manual lifecycle management in Go works well for smaller applications with simple dependencies. It keeps the control flow clear and aligns with Go&rsquo;s preference for direct, explicit code. But as more components are added, each with their own startup and shutdown requirements, manual wiring becomes more difficult to maintain and more likely to break.</p>
<p>The component library helps manage this complexity by introducing a structure for declaring and orchestrating components. It handles dependency resolution, startup sequencing, and shutdown ordering automatically. This reduces boilerplate and improves the reliability of long-running systems without hiding too much logic or requiring major changes to Go&rsquo;s usual patterns.</p>
<p>For teams working on modular or service-heavy systems, component provides a practical way to scale lifecycle management while preserving the clarity and maintainability expected in Go projects.</p>

        </div>
    </article>

    <hr />

    <div class="post-info">
        
        
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://www.jacoelho.com/categories/go/">go</a></span>
        <span class="tag"><a href="https://www.jacoelho.com/categories/golang/">golang</a></span>
        <span class="tag"><a href="https://www.jacoelho.com/categories/dependency-injection/">dependency injection</a></span>
        <span class="tag"><a href="https://www.jacoelho.com/categories/dependency-lifecycle/">dependency lifecycle</a></span>
        <span class="tag"><a href="https://www.jacoelho.com/categories/di/">di</a></span>
        
    </p>

    </div>
</main>

            </div>

            
                <footer class="footer">
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2025</span>
            <span><a href="https://www.jacoelho.com/">Jose Coelho</a></span>
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span><a href="https://www.jacoelho.com/blog/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
            
        </div>
    </div>
    
    
</footer>
            
        </div>

        




<script type="text/javascript" src="https://www.jacoelho.com/bundle.min.908900dc2e07f8e32ffd6d1405df0d337b6aecaff233e8551b43a679393ed2b033974b6d1151b2d97ca25722a7c880f508bb953081bd4606f742ff4c7de5029e.js" integrity="sha512-kIkA3C4H&#43;OMv/W0UBd8NM3tq7K/yM&#43;hVG0OmeTk&#43;0rAzl0ttEVGy2XyiVyKnyID1CLuVMIG9Rgb3Qv9MfeUCng=="></script>



    </body>
</html>
