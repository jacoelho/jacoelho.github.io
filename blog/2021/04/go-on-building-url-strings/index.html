<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="map[name:Jose Coelho]"><meta name=description content="Ramblings about software engineering"><meta name=keywords content="go,golang,kubernetes,ansible,chef,kafka,docker,containers"><link rel=canonical href=https://www.jacoelho.com/blog/2021/04/go-on-building-url-strings/><title>Go - On building URL strings :: Posts</title><link rel=stylesheet href=https://www.jacoelho.com/css/main.min.6f3353616359b0fe4cfe1d29dc41b46980dd1459838e2e6175f34881197cc945.css integrity="sha256-bzNTYWNZsP5M/h0p3EG0aYDdFFmDji5hdfNIgRl8yUU=" crossorigin=anonymous><meta itemprop=name content="Go - On building URL strings"><meta itemprop=description content="Building URL strings in Go may be accomplished in a couple different ways:
url.Parse string concatenation (using +) fmt.Sprintf bytes.Buffer strings.Builder You may be asking yourself: which one should I use, then? As always, the answer depends. Let us explore why.
URL.Parse Before we start, a quick refresh on the URL structure:
One important fact to be aware is that when building URLs manually, it is easy to forget the percentage-encoding."><meta itemprop=datePublished content="2021-04-17T10:00:00+00:00"><meta itemprop=dateModified content="2021-04-17T10:00:00+00:00"><meta itemprop=wordCount content="773"><meta itemprop=keywords content="Go,Golang,Url"><meta property="og:url" content="https://www.jacoelho.com/blog/2021/04/go-on-building-url-strings/"><meta property="og:site_name" content="Posts"><meta property="og:title" content="Go - On building URL strings"><meta property="og:description" content="Building URL strings in Go may be accomplished in a couple different ways:
url.Parse string concatenation (using +) fmt.Sprintf bytes.Buffer strings.Builder You may be asking yourself: which one should I use, then? As always, the answer depends. Let us explore why.
URL.Parse Before we start, a quick refresh on the URL structure:
One important fact to be aware is that when building URLs manually, it is easy to forget the percentage-encoding."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-04-17T10:00:00+00:00"><meta property="article:modified_time" content="2021-04-17T10:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go - On building URL strings"><meta name=twitter:description content="Building URL strings in Go may be accomplished in a couple different ways:
url.Parse string concatenation (using +) fmt.Sprintf bytes.Buffer strings.Builder You may be asking yourself: which one should I use, then? As always, the answer depends. Let us explore why.
URL.Parse Before we start, a quick refresh on the URL structure:
One important fact to be aware is that when building URLs manually, it is easy to forget the percentage-encoding."><meta property="article:published_time" content="2021-04-17 10:00:00 +0000 UTC"><meta property="article:section" content="go"><meta property="article:section" content="golang"><meta property="article:section" content="url"></head><body><header class=header><div class=container><div class=header-inner><a href=https://www.jacoelho.com/ class=logo>Jose Coelho</a><nav class=nav><button class=menu-trigger aria-label="Toggle menu" aria-expanded=false>
<svg width="24" height="24"><use href="https://www.jacoelho.com/icons.svg#menu"/></svg></button><div class=nav-menu><ul class=menu><li class=menu-item><a href=https://www.jacoelho.com/about/>About</a></li></ul><button class=theme-toggle aria-label="Toggle theme">
<svg class="theme-icon-light" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#sun"/></svg>
<svg class="theme-icon-dark" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#moon"/></svg>
</button>
<a href=https://www.jacoelho.com/index.xml class=rss-link target=_blank rel=noopener aria-label=RSS><svg width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#rss"/></svg></a></div></nav></div></div></header><div class=container><div class=content><main class=post><article><header class=post-header><h1 class=post-title>Go - On building URL strings</h1></header><div class=post-content><p>Building URL strings in Go may be accomplished in a couple different ways:</p><ul><li><code>url.Parse</code></li><li>string concatenation (using <code>+</code>)</li><li><code>fmt.Sprintf</code></li><li><code>bytes.Buffer</code></li><li><code>strings.Builder</code></li></ul><p>You may be asking yourself: which one should I use, then? As always, the answer depends. Let us explore why.</p><h2 id=urlparse><code>URL.Parse</code></h2><p>Before we start, a quick refresh on the URL structure:</p><p><img src=https://www.jacoelho.com/images/url.png alt=url></p><p>One important fact to be aware is that when building URLs manually, it is easy to forget the <a href=https://en.wikipedia.org/wiki/Percent-encoding>percentage-encoding</a>.</p><p>The <a href=https://golang.org/pkg/net/url/>url package</a> implements the URL parsing and query encoding logic, although the api may be easy to misuse, like in the examples below.</p><p>Using <code>url.Parse</code> to parse a string:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net/url&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;https://example.org/resource?filter[page]=1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/resource?filter[page]=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>url.Parse</code> does not check if the query is properly encoded. However, it is possible to fix it by retrieving the query section and encoding it explicitly:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net/url&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;https://example.org/resource?filter[page]=1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/resource?filter[page]=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>.</span><span class=nx>RawQuery</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>u</span><span class=p>.</span><span class=nf>Query</span><span class=p>().</span><span class=nf>Encode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/resource?filter%5Bpage%5D=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Another possible way to encode query string is using <code>url.Values</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net/url&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;https://example.org/foo&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>query</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nx>Values</span><span class=p>{}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>query</span><span class=p>.</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;filter[page]&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>.</span><span class=nx>RawQuery</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>query</span><span class=p>.</span><span class=nf>Encode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/foo?filter%5Bpage%5D=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>On query building abstractions, the <a href=https://github.com/google/go-querystring>go-querystring</a> package provides some extra functionality around <code>url.Values</code>, but follows the initial <code>RawQuery</code> usage.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;net/url&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=s>&#34;github.com/google/go-querystring/query&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>Options</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>Page</span><span class=w> </span><span class=kt>string</span><span class=w> </span><span class=s>`url:&#34;filter[page]&#34;`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=s>&#34;https://example.org/foo&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/foo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>q</span><span class=p>,</span><span class=w> </span><span class=nx>_</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>query</span><span class=p>.</span><span class=nf>Values</span><span class=p>(</span><span class=nx>Options</span><span class=p>{</span><span class=nx>Page</span><span class=p>:</span><span class=w> </span><span class=s>&#34;1&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>.</span><span class=nx>RawQuery</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nf>Encode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// prints https://example.org/foo?filter%5Bpage%5D=1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>u</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Something to be aware with <code>url.Parse</code> is that <code>http.NewRequestWithContext</code> signature is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewRequestWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>url</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>body</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>URL argument type is string, but it will be parsed to <code>url.URL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=nf>NewRequestWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>method</span><span class=p>,</span><span class=w> </span><span class=nx>url</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>body</span><span class=w> </span><span class=nx>io</span><span class=p>.</span><span class=nx>Reader</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>Request</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>// omitted code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>urlpkg</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span><span class=w> </span><span class=cp>//net/url package</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span></code></pre></div><p>When using <code>http.NewRequestWithContext</code>, regardless of the method selected to build the URL string, <code>url.Parse</code> is going to be called at least once.</p><h2 id=community-usage>Community Usage</h2><p>It is always interesting to check how the community tackles this issue to understand if there is a clear preference.</p><h3 id=go-github><code>go-github</code></h3><p><a href=https://github.com/google/go-github/blob/master/github/pulls.go#L165>https://github.com/google/go-github/blob/master/github/pulls.go#L165</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>PullRequestsService</span><span class=p>)</span><span class=w> </span><span class=nf>ListPullRequestsWithCommit</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>owner</span><span class=p>,</span><span class=w> </span><span class=nx>repo</span><span class=p>,</span><span class=w> </span><span class=nx>sha</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>opts</span><span class=w> </span><span class=o>*</span><span class=nx>PullRequestListOptions</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=o>*</span><span class=nx>PullRequest</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=nx>Response</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;repos/%v/%v/commits/%v/pulls&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>owner</span><span class=p>,</span><span class=w> </span><span class=nx>repo</span><span class=p>,</span><span class=w> </span><span class=nx>sha</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nf>addOptions</span><span class=p>(</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>opts</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// https://github.com/google/go-github/blob/master/github/github.go#L242</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>addOptions</span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>opts</span><span class=w> </span><span class=kd>interface</span><span class=p>{})</span><span class=w> </span><span class=p>(</span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>v</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>reflect</span><span class=p>.</span><span class=nf>ValueOf</span><span class=p>(</span><span class=nx>opts</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>v</span><span class=p>.</span><span class=nf>Kind</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nx>reflect</span><span class=p>.</span><span class=nx>Ptr</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>v</span><span class=p>.</span><span class=nf>IsNil</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>s</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>url</span><span class=p>.</span><span class=nf>Parse</span><span class=p>(</span><span class=nx>s</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>s</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>qs</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>query</span><span class=p>.</span><span class=nf>Values</span><span class=p>(</span><span class=nx>opts</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=nx>s</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>u</span><span class=p>.</span><span class=nx>RawQuery</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>qs</span><span class=p>.</span><span class=nf>Encode</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>return</span><span class=w> </span><span class=nx>u</span><span class=p>.</span><span class=nf>String</span><span class=p>(),</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>In this repo <code>fmt.Sprintf</code> is used in conjunction with <code>go-querystring</code> package.</p><h3 id=consul-client><code>consul client</code></h3><p><a href=https://github.com/hashicorp/consul/blob/api/v1.8.1/api/acl.go#L616>https://github.com/hashicorp/consul/blob/api/v1.8.1/api/acl.go#L616</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>a</span><span class=w> </span><span class=o>*</span><span class=nx>ACL</span><span class=p>)</span><span class=w> </span><span class=nf>TokenClone</span><span class=p>(</span><span class=nx>tokenID</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>description</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>q</span><span class=w> </span><span class=o>*</span><span class=nx>WriteOptions</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>ACLToken</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=nx>WriteMeta</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>if</span><span class=w> </span><span class=nx>tokenID</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Must specify a tokenID for Token Cloning&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>r</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>a</span><span class=p>.</span><span class=nx>c</span><span class=p>.</span><span class=nf>newRequest</span><span class=p>(</span><span class=s>&#34;PUT&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;/v1/acl/token/&#34;</span><span class=o>+</span><span class=nx>tokenID</span><span class=o>+</span><span class=s>&#34;/clone&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>String concatenation is used in this case.</p><h3 id=godo>godo</h3><p><a href=https://github.com/digitalocean/godo/blob/main/droplets.go#L322>https://github.com/digitalocean/godo/blob/main/droplets.go#L322</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// ListByTag lists all Droplets matched by a Tag.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>s</span><span class=w> </span><span class=o>*</span><span class=nx>DropletsServiceOp</span><span class=p>)</span><span class=w> </span><span class=nf>ListByTag</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span><span class=w> </span><span class=nx>tag</span><span class=w> </span><span class=kt>string</span><span class=p>,</span><span class=w> </span><span class=nx>opt</span><span class=w> </span><span class=o>*</span><span class=nx>ListOptions</span><span class=p>)</span><span class=w> </span><span class=p>([]</span><span class=nx>Droplet</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=nx>Response</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=nx>path</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s?tag_name=%s&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>dropletBasePath</span><span class=p>,</span><span class=w> </span><span class=nx>tag</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>In this repo <code>fmt.Sprintf</code> is used in conjunction with <code>go-querystring</code> package.</p><h2 id=benchmark>Benchmark</h2><p>Looking at community usage, anecdotally <code>fmt.Sprintf</code> seems to be the preferred method.</p><p>Is there a numeric reason behind it? A simple way to test is benchmark URL building techniques and formats:</p><ul><li>All fields are strings: &ldquo;<a href=https://example.com/resource/00000000-0000-0000-0000-000000000000%22>https://example.com/resource/00000000-0000-0000-0000-000000000000"</a></li><li>At least one field is an int which we need to convert: &ldquo;<a href=https://example.com/resource/314159265%22>https://example.com/resource/314159265"</a></li></ul><p>Running with <code>go test -bench=. -benchtime=10s</code></p><pre tabindex=0><code>BenchmarkBytesString-24                                 91364389               131.1 ns/op           320 B/op          3 allocs/op
BenchmarkBytesStringAndItoa-24                          100000000              100.8 ns/op           128 B/op          3 allocs/op
BenchmarkConcatString-24                                247271304               48.57 ns/op           80 B/op          1 allocs/op
BenchmarkConcatStringAndItoa-24                         150584938               79.36 ns/op           64 B/op          2 allocs/op
BenchmarkSprinfString-24                                56899111               210.9 ns/op           128 B/op          4 allocs/op
BenchmarkSprinfDigit-24                                 54090478               226.2 ns/op            88 B/op          4 allocs/op
BenchmarkSprinfDigitItoa-24                             46432692               256.5 ns/op           112 B/op          5 allocs/op
BenchmarkStringBuilderString-24                         123711208               97.40 ns/op          168 B/op          3 allocs/op
BenchmarkStringBuilderStringAndItoa-24                  123868472               96.78 ns/op           88 B/op          3 allocs/op
BenchmarkURLParseString-24                              14717494               815.6 ns/op           256 B/op          4 allocs/op
BenchmarkURLParseResolveReference-24                     5361052              2236 ns/op            1040 B/op         16 allocs/op
BenchmarkURLQueryEncode-24                               9121402              1312 ns/op             536 B/op         11 allocs/op
BenchmarkURLQueryEncodePackageQueryString-24             6446503              1864 ns/op             984 B/op         17 allocs/op
</code></pre><p>Looking at benchmark results, string concatenation and <code>strings.Builder</code> seem the fastest and doing fewer allocations.</p><p>When not possible to ensure the URL will be correctly encoded, use <code>url.Parse</code> and call <code>Encode</code> explicitly.</p><p>While <code>go-querystring</code> usability may be convenient, it infers a performance cost price.</p><p>Benchmark code available at <a href=https://github.com/jacoelho/url_build_benchmark>https://github.com/jacoelho/url_build_benchmark</a>.</p></div></article></main></div></div><footer class=footer><div class=container><div class=footer-content><span>&copy; 2025 Jose Coelho</span></div></div></footer><script src=https://www.jacoelho.com/js/bundle.min.c687f63d8e204d7466c7c9609ec6f61b44c1217490b36198e5f77ee3befc11ea.js integrity="sha256-xof2PY4gTXRmx8lgnsb2G0TBIXSQs2GY5fd+4778Eeo=" crossorigin=anonymous></script></body></html>