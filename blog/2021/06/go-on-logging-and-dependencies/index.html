<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="Jose Coelho"><meta name=description content="Ramblings about software engineering"><meta name=keywords content="go,golang,kubernetes,ansible,chef,kafka,docker,containers"><link rel=canonical href=https://www.jacoelho.com/blog/2021/06/go-on-logging-and-dependencies/><title>Go - On logging and dependencies :: Posts</title><link rel=stylesheet href=https://www.jacoelho.com/css/main.min.6f3353616359b0fe4cfe1d29dc41b46980dd1459838e2e6175f34881197cc945.css integrity="sha256-bzNTYWNZsP5M/h0p3EG0aYDdFFmDji5hdfNIgRl8yUU=" crossorigin=anonymous><meta itemprop=name content="Go - On logging and dependencies"><meta itemprop=description content='Doing code reviews, I have sometimes noticed libraries forcing dependencies on the users.
While it is perfectly acceptable if well justified and documented, it sometimes feels like adding unnecessary baggage.
A typical example would be something like the following snippet:
func (c *Client) HealthCheck(ctx context.Context) error { logrus.Debug("sending get request") req, err := http.NewRequestWithContext(ctx, http.MethodGet, c.url, nil) if err != nil { return err } resp, err := c.client.Do(req) if err != nil { return err } logrus.Debugf("http status code was %d", resp.StatusCode) defer resp.Body.Close() return nil } Using logrus, as example, picking this code, one would need to check how logrus works, which configurations are available, which version should be used and so on.'><meta itemprop=datePublished content="2021-06-08T10:00:00+00:00"><meta itemprop=dateModified content="2021-06-08T10:00:00+00:00"><meta itemprop=wordCount content="346"><meta itemprop=keywords content="Go,Golang,Roundtripper"><meta property="og:url" content="https://www.jacoelho.com/blog/2021/06/go-on-logging-and-dependencies/"><meta property="og:site_name" content="Posts"><meta property="og:title" content="Go - On logging and dependencies"><meta property="og:description" content='Doing code reviews, I have sometimes noticed libraries forcing dependencies on the users.
While it is perfectly acceptable if well justified and documented, it sometimes feels like adding unnecessary baggage.
A typical example would be something like the following snippet:
func (c *Client) HealthCheck(ctx context.Context) error { logrus.Debug("sending get request") req, err := http.NewRequestWithContext(ctx, http.MethodGet, c.url, nil) if err != nil { return err } resp, err := c.client.Do(req) if err != nil { return err } logrus.Debugf("http status code was %d", resp.StatusCode) defer resp.Body.Close() return nil } Using logrus, as example, picking this code, one would need to check how logrus works, which configurations are available, which version should be used and so on.'><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-06-08T10:00:00+00:00"><meta property="article:modified_time" content="2021-06-08T10:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go - On logging and dependencies"><meta name=twitter:description content='Doing code reviews, I have sometimes noticed libraries forcing dependencies on the users.
While it is perfectly acceptable if well justified and documented, it sometimes feels like adding unnecessary baggage.
A typical example would be something like the following snippet:
func (c *Client) HealthCheck(ctx context.Context) error { logrus.Debug("sending get request") req, err := http.NewRequestWithContext(ctx, http.MethodGet, c.url, nil) if err != nil { return err } resp, err := c.client.Do(req) if err != nil { return err } logrus.Debugf("http status code was %d", resp.StatusCode) defer resp.Body.Close() return nil } Using logrus, as example, picking this code, one would need to check how logrus works, which configurations are available, which version should be used and so on.'><meta property="article:published_time" content="2021-06-08 10:00:00 +0000 UTC"><meta property="article:section" content="go"><meta property="article:section" content="golang"><meta property="article:section" content="roundtripper"></head><body><header class=header><div class=container><div class=header-inner><a href=https://www.jacoelho.com/ class=logo>Jose Coelho</a><nav class=nav><button class=menu-trigger aria-label="Toggle menu" aria-expanded=false>
<svg width="24" height="24"><use href="https://www.jacoelho.com/icons.svg#menu"/></svg></button><div class=nav-menu><ul class=menu><li class=menu-item><a href=https://www.jacoelho.com/about/>About</a></li></ul><button class=theme-toggle aria-label="Toggle theme">
<svg class="theme-icon-light" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#sun"/></svg>
<svg class="theme-icon-dark" width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#moon"/></svg>
</button>
<a href=https://www.jacoelho.com/index.xml class=rss-link target=_blank rel=noopener aria-label=RSS><svg width="20" height="20"><use href="https://www.jacoelho.com/icons.svg#rss"/></svg></a></div></nav></div></div></header><div class=container><div class=content><main class=post><article><header class=post-header><h1 class=post-title>Go - On logging and dependencies</h1></header><div class=post-content><p>Doing code reviews, I have sometimes noticed libraries forcing dependencies on the users.</p><p>While it is perfectly acceptable if well justified and documented, it sometimes feels like adding unnecessary baggage.</p><p>A typical example would be something like the following snippet:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>c</span><span class=w> </span><span class=o>*</span><span class=nx>Client</span><span class=p>)</span><span class=w> </span><span class=nf>HealthCheck</span><span class=p>(</span><span class=nx>ctx</span><span class=w> </span><span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span><span class=w> </span><span class=kt>error</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>logrus</span><span class=p>.</span><span class=nf>Debug</span><span class=p>(</span><span class=s>&#34;sending get request&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>req</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nf>NewRequestWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span><span class=w> </span><span class=nx>http</span><span class=p>.</span><span class=nx>MethodGet</span><span class=p>,</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>url</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>c</span><span class=p>.</span><span class=nx>client</span><span class=p>.</span><span class=nf>Do</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>logrus</span><span class=p>.</span><span class=nf>Debugf</span><span class=p>(</span><span class=s>&#34;http status code was %d&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>StatusCode</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>resp</span><span class=p>.</span><span class=nx>Body</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Using logrus, as example, picking this code, one would need to check how logrus works, which configurations are available, which version should be used and so on.</p><p>Russ Cox wrote an excellent <a href=https://research.swtch.com/deps>blog post</a> on what considerations one should make when picking software.</p><p>There are multiples ways to improve observability; for an in-depth post on the subject check <a href=https://martinfowler.com/articles/domain-oriented-observability.html>Domain-Oriented Observability</a></p><hr><p>Using the http.Client example, in Go it is possible to improve observability without <em>poluting</em> the code or adding dependencies by leveraging the <a href=https://golang.org/pkg/net/http/#RoundTripper>http.RoundTripper</a> and <a href=https://en.wikipedia.org/wiki/Dependency_injection>dependency injection</a>.</p><p>One way to implement it could be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span><span class=w> </span><span class=nx>Logger</span><span class=w> </span><span class=kd>func</span><span class=p>(</span><span class=nx>args</span><span class=w> </span><span class=o>...</span><span class=kd>interface</span><span class=p>{})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>type</span><span class=w> </span><span class=nx>DebugTransport</span><span class=w> </span><span class=kd>struct</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>rt</span><span class=w>     </span><span class=nx>http</span><span class=p>.</span><span class=nx>RoundTripper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>logger</span><span class=w> </span><span class=nx>Logger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=p>(</span><span class=nx>d</span><span class=w> </span><span class=o>*</span><span class=nx>DebugTransport</span><span class=p>)</span><span class=w> </span><span class=nf>RoundTrip</span><span class=p>(</span><span class=nx>request</span><span class=w> </span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Response</span><span class=p>,</span><span class=w> </span><span class=kt>error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>requestBody</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>httputil</span><span class=p>.</span><span class=nf>DumpRequestOut</span><span class=p>(</span><span class=nx>request</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nf>logger</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>requestBody</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>rt</span><span class=p>.</span><span class=nf>RoundTrip</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>respBody</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>httputil</span><span class=p>.</span><span class=nf>DumpResponse</span><span class=p>(</span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nx>d</span><span class=p>.</span><span class=nf>logger</span><span class=p>(</span><span class=nb>string</span><span class=p>(</span><span class=nx>respBody</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nx>resp</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This code allows logging requests and responses without deciding which logger to use and remove logging calls from the library.</p><p>Example output:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>GET / HTTP/1.1
</span></span><span class=line><span class=cl>Host: 127.0.0.1:43411
</span></span><span class=line><span class=cl>User-Agent: Go-http-client/1.1
</span></span><span class=line><span class=cl>Accept-Encoding: gzip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>500</span> Internal Server Error
</span></span><span class=line><span class=cl>Date: Tue, <span class=m>08</span> Jun <span class=m>2021</span> 20:33:38 GMT
</span></span><span class=line><span class=cl>Content-Length: <span class=m>0</span>
</span></span></code></pre></div><p>Similar logic could be implemented to add tracing, for example, the way <a href=https://opentelemetry.io/>opentelemetry</a> implements <a href=https://pkg.go.dev/go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp>otelhttp.Transport</a></p><p>When developing libraries (or anything to be fair), one should think: Is this dependency needed? Can I implement a feature while not committing to any concrete implementation?</p><p>Your users will appreciate it.</p><br><p>Code examples available in <a href=https://github.com/jacoelho/code-playground/tree/main/roundtripper>github</a></p></div></article></main></div></div><footer class=footer><div class=container><div class=footer-content><span>&copy; 2025 Jose Coelho</span></div></div></footer><script src=https://www.jacoelho.com/js/bundle.min.c687f63d8e204d7466c7c9609ec6f61b44c1217490b36198e5f77ee3befc11ea.js integrity="sha256-xof2PY4gTXRmx8lgnsb2G0TBIXSQs2GY5fd+4778Eeo=" crossorigin=anonymous></script></body></html>